<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>F!RST ‚Äî Flat Ghibli (v6)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<style>
  :root{
    --bg:#0c1014;
    --sky1:#6bb7ff; --sky2:#bfe4ff;
    --panel:#151a22; --panel-b:#232b39;
    --text:#f2f5fb; --muted:#aab3c2;
    --accent:#8fb1ff; --accent2:#ffd36b; --accent3:#ff9aa4; --accent4:#9ff3c7;
    --slot:#1b2030; --slot-b:#2a3244;
    --card:#1e2432; --card-b:#2f3850; --card-edge:#c8d2ee22;
    --outline:#4a5a84;
    --ring:#3aa1ff80;
    --win:#44d18c; --lose:#e05b6f;
    --forbid:#ffd36b; --forbid-strong:#ffb400; --forbid-trigger:#ff5e6e;
    --card-w:clamp(86px, 14.5vw, 140px);
  }
  *{box-sizing:border-box}
  html,body{height:100svh; height:100dvh; margin:0; background:var(--bg); color:var(--text);
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; overflow:hidden; overscroll-behavior:none}
  body::before{
    content:""; position:fixed; inset:0; background:
      radial-gradient(ellipse at 20% 30%, rgba(255,255,255,.12), transparent 50%),
      radial-gradient(ellipse at 70% 20%, rgba(255,255,255,.10), transparent 55%),
      linear-gradient(180deg, var(--sky2), var(--sky1));
    z-index:-2; opacity:.25;
  }
  body::after{
    content:""; position:fixed; inset:auto 0 0 0; height:45%;
    background:linear-gradient(180deg, #122036, #0c1014); z-index:-2;
  }

  .wrap{position:relative; width:100vw; height:100%; display:flex; flex-direction:column; overflow:hidden}
  .rotatable{position:relative; width:100%; height:100%; transform-origin:center; overflow:auto}

  header{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 14px}
  .titlebar{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  h1{font-size:18px;margin:0;color:var(--accent)}
  .bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid var(--panel-b);background:#0f1422b3;color:#dae6ff;font-size:12px;backdrop-filter:blur(4px)}
  .btn{background:#1a2233;color:var(--text);border:1px solid var(--panel-b);border-radius:10px;padding:8px 12px;cursor:pointer}
  .btn:hover{background:#1f2a40}
  .icon-btn{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:900}

  /* Board layout */
  .boardWrap{
    position:relative; flex:1; display:grid; grid-template-columns: 1fr minmax(220px,300px);
    gap:12px; padding:0 12px 12px 12px; overflow:auto;
  }
  .leftCol{display:grid; grid-template-rows: 1fr 1fr auto; gap:12px; min-width:0; min-height:0}
  .rightCol{display:grid; grid-template-rows:auto auto minmax(120px, 1fr); gap:12px; min-width:0; min-height:0}

  .panel{background:linear-gradient(180deg, #121722, #0e1420);border:1px solid var(--panel-b);border-radius:14px;padding:10px; box-shadow: 0 10px 16px rgba(0,0,0,.22), inset 0 1px 0 #ffffff10; overflow:hidden; min-height:0}
  .title{font-weight:800;margin-bottom:6px;font-size:14px;color:#dbe5ff; letter-spacing:.3px; text-shadow:0 1px 0 #000; display:flex; align-items:center; gap:8px}
  .chip{font-size:11px; padding:2px 6px; border:1px solid #2f3a56; border-radius:999px; background:#101828; color:#d8e1ff}
  .note{font-size:12px;color:var(--muted)}

  .boardFlat{position:relative; width:100%; border-radius:14px; background:linear-gradient(180deg, #182132, #0d1422);
    border:1px solid #2d3a55; box-shadow: inset 0 0 0 2px #0b101a, 0 10px 24px rgba(0,0,0,.30); overflow:hidden; contain:layout paint size;
    min-height:160px; height:auto;
  }
  .zone{position:absolute; inset:12px; display:flex; gap:10px; flex-wrap:wrap; align-content:flex-start}

  /* Forbid visuals ‚Äì ONLY on F card */
  .forbidFx{outline:2px solid var(--forbid); box-shadow: 0 0 0 10px #ffd36b20 inset, 0 0 18px #ffd36b66; position:relative}
  .forbidFx::after{content:""; position:absolute; top:-3px; left:-3px; right:-3px; height:6px; background:linear-gradient(90deg, var(--forbid-strong), var(--forbid)); border-radius:9px}
  @keyframes forbidPulse{ 0%{transform:scale(1)} 50%{transform:scale(1.03)} 100%{transform:scale(1)} }
  .forbidFx{animation:forbidPulse 1.2s ease-in-out infinite}
  .triggerFlash{position:absolute; inset:-2px; background:radial-gradient(ellipse at center, #ff5e6e55, transparent 55%); pointer-events:none; animation:flash .7s ease forwards; border-radius:12px}
  @keyframes flash{ from{opacity:1} to{opacity:0} }

  .card{width:var(--card-w); height:calc(var(--card-w)*0.82); border-radius:12px; border:1px solid var(--card-b);
    background:linear-gradient(180deg, #1d2536, #141b2a); display:flex; align-items:center; justify-content:center; position:relative;
    box-shadow: 0 8px 14px rgba(0,0,0,.35), inset 0 0 0 2px var(--card-edge); transition:transform .12s ease-out, box-shadow .12s ease-out, filter .12s ease-out;}
  .card.clickable{cursor:pointer}
  .card.clickable:hover{box-shadow: 0 10px 16px rgba(0,0,0,.4), 0 0 0 2px var(--outline) inset; transform:translateY(-2px)}
  .L{font-size:clamp(40px,7vw,60px); font-weight:1000; letter-spacing:2px; line-height:1; text-shadow: 0 1px 0 #000}
  .L.F{color:#9cc8ff} .L.I{color:#a9ffcf} .L.R{color:#ffd195} .L.S{color:#ff9aa4} .L.T{color:#c6b3ff}

  /* Turn highlighting */
  .activeTurn{outline:2px solid var(--ring); box-shadow: 0 0 0 6px #3aa1ff14 inset, 0 0 0 2px var(--ring) inset}
  #panelYouSpace.activeTurn .title::after{content:" (your turn)"; color:#9ff3c7}
  #panelAiSpace.activeTurn .title::after{content:" (AI turn)"; color:#ffb8c1}

  /* Win/Lose highlighting */
  .winGlow{outline:2px solid #44d18c; box-shadow: 0 0 0 6px #44d18c22 inset, 0 0 16px #44d18c66}
  .loseGlow{outline:2px solid #e05b6f55; box-shadow: 0 0 0 6px #e05b6f18 inset}

  .stackPiles{display:grid; gap:10px; overflow:hidden}
  .pile{position:relative; display:inline-flex; align-items:flex-end; gap:10px; flex-wrap:nowrap; padding-left:24px; max-width:100%}
  .pile .mini{width:34px; height:46px; background:linear-gradient(180deg,#1b2232,#111826); border:1px solid #2f3850; border-radius:7px; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 10px rgba(0,0,0,.28); flex:0 0 auto}
  .pile .mini b{font-size:20px; line-height:1; text-shadow:0 1px 0 #000}
  .pile .mini + .mini{margin-left:-14px}
  .pile .count{position:absolute; top:-8px; right:-8px; background:#0f1422; border:1px solid #2a3244; color:#dbe5ff; padding:2px 6px; font-size:12px; border-radius:999px}

  .handPanel{padding:10px}
  .handRow{display:flex; gap:8px; flex-wrap:wrap; align-items:flex-start; padding:4px}

  /* Log panel constrained with internal scroll */
  .logPanel{min-height:0; display:flex; flex-direction:column}
  .logPanel .title{margin-bottom:6px}
  .log{flex:1 1 auto; min-height:0; max-height:100%; overflow:auto; background:#0e1524; border:1px solid #25314a; border-radius:10px; padding:10px; color:#c6d0ec; font-size:13px; line-height:1.35}

  /* Modals */
  .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; padding:16px; z-index:90; backdrop-filter: blur(2px)}
  .modal .box{background:#10182a; border:1px solid #2a3450; border-radius:14px; max-width:720px; width:100%; box-shadow:0 10px 24px rgba(0,0,0,.5)}
  .modal .head{display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid #253254}
  .modal .body{padding:12px}
  .choices{display:flex; gap:8px; flex-wrap:wrap}
  .choice{padding:8px 12px; border:1px solid #2a3142; border-radius:10px; background:#161b28; color:#dbe5ff; cursor:pointer}
  .choice:hover{outline:2px solid var(--outline)}

  /* Menu */
  .menu{position:fixed; inset:0; z-index:80; display:flex; align-items:center; justify-content:center; padding:16px; background:radial-gradient(1200px 600px at 50% 10%, #1a2440cc, transparent), linear-gradient(180deg,#0e1422f2,#0a0f18f2)}
  .menu .cardmenu{background:linear-gradient(180deg,#0f1728,#0b1220); border:1px solid #2d3754; border-radius:20px; padding:22px; width:min(520px,92vw); box-shadow:0 28px 56px rgba(0,0,0,.55); display:flex; flex-direction:column; align-items:center}
  .menu .muted{color:#acb6cf; font-size:14px; margin-bottom:12px}
  .menu .items{display:flex; flex-direction:column; align-items:center; gap:12px; width:100%}
  .menu .btn.big{font-size:16px; font-weight:800; padding:14px 18px; width:80%; max-width:360px}

  /* Dice */
  .diceOverlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:85; background:rgba(5,8,12,.6)}
  .diceArea{display:flex; gap:40px; align-items:center}
  .die{width:72px; height:72px; position:relative; transform-style:preserve-3d; transform:rotateX(0) rotateY(0)}
  .face{position:absolute; width:100%; height:100%; background:#e8eefc; border-radius:10px; box-shadow:inset 0 0 0 2px #b5c3ea; display:flex; align-items:center; justify-content:center; font-weight:900; color:#1b2b5a; font-size:28px}
  .face:nth-child(1){transform:translateZ(36px)}
  .face:nth-child(2){transform:rotateY(90deg) translateZ(36px)}
  .face:nth-child(3){transform:rotateY(180deg) translateZ(36px)}
  .face:nth-child(4){transform:rotateY(-90deg) translateZ(36px)}
  .face:nth-child(5){transform:rotateX(90deg) translateZ(36px)}
  .face:nth-child(6){transform:rotateX(-90deg) translateZ(36px)}
  .diceTxt{color:#dbe5ff; font-weight:800; text-shadow:0 1px 0 #000}

  .toast{position:fixed; bottom:calc(14px + env(safe-area-inset-bottom)); left:50%; transform:translateX(-50%); background:#111522; border:1px solid #232a3a; padding:10px 14px; border-radius:10px; color:#e7ecff; font-size:13px; display:none; z-index:95}

  .orientTip{position:fixed; top:calc(8px + env(safe-area-inset-top)); right:8px; background:#0f1422aa; color:#dbe5ff; border:1px solid #273250; border-radius:10px; padding:6px 10px; font-size:12px; z-index:30; display:none}

  ::-webkit-scrollbar{height:8px;width:8px}
  ::-webkit-scrollbar-track{background:#0b1019}
  ::-webkit-scrollbar-thumb{background:#22334a;border-radius:8px}

  @media (max-width: 820px){
    :root{ --card-w: clamp(72px, 18vw, 120px); }
    .L{font-size:clamp(34px,6vw,52px)}
    header h1{font-size:16px}
    .boardWrap{grid-template-columns:1fr; overflow:auto; padding-bottom:8px}
    .rightCol{grid-template-rows:auto auto minmax(120px, 1fr)}
  }

  /* Portrait rotation: rotate the WHOLE .rotatable */
  .portrait .rotatable{
    position:absolute; top:50%; left:50%; transform: translate(-50%,-50%) rotate(90deg) scale(var(--scale,0.95));
    width:100svh; width:100dvh; height:100svh; height:100dvh; overflow:auto;
  }
  .portrait .orientTip{display:block}
</style>
</head>
<body>
<div class="wrap">
  <div id="rot" class="rotatable">
    <header>
      <div class="titlebar">
        <h1 id="titleTxt">F!RST ‚Äî flat ghibli</h1>
        <span class="pill"><span id="turnKey">Turn</span>: <b id="turnLbl">‚Äî</b></span>
        <span class="pill"><span id="diceKey">Dice</span>: <b id="diceLbl">‚Äî</b></span>
        <span class="pill"><span id="yourHandKey">Your hand</span>: <b id="youHandCount">0</b>/7</span>
        <span class="pill"><span id="aiHandKey">AI hand</span>: <b id="aiHandCount">0</b> (<span id="hiddenKey">hidden</span>)</span>
        <span class="pill" id="forbidAIPill" style="display:none"></span>
        <span class="pill" id="forbidYouPill" style="display:none"></span>
      </div>
      <div class="bar">
        <button class="btn" id="langBtn" title="Language">üá¨üáß EN</button>
        <button class="btn" id="fullBtn">Fullscreen</button>
        <button class="btn" id="toMenuBtn">Menu</button>
        <button class="btn icon-btn" id="helpBtn">?</button>
        <button class="btn" id="restartBtn">New Game</button>
      </div>
    </header>

    <div id="gameArea" class="gameArea" style="position:relative; width:100%; height:calc(100% - 64px);">
      <div class="boardWrap">
        <div class="leftCol">
          <!-- AI Board (top) -->
          <div id="panelAiSpace" class="panel">
            <div class="title"><span id="aiSpaceTitle">SPACE ‚Äî AI</span> <span id="aiForbidChip" class="chip" style="display:none"></span></div>
            <div class="boardFlat">
              <div id="aiSpace" class="zone"></div>
            </div>
          </div>
          <!-- Player Board (middle) -->
          <div id="panelYouSpace" class="panel">
            <div class="title"><span id="youSpaceTitle">SPACE ‚Äî You</span> <span id="youForbidChip" class="chip" style="display:none"></span></div>
            <div class="boardFlat">
              <div id="youSpace" class="zone"></div>
            </div>
          </div>
          <!-- Hand -->
          <div class="panel handPanel">
            <div class="title" id="yourHandTitle">Your hand <span class="note" id="handNote">(tap a card to play; turn ends automatically)</span></div>
            <div id="youHand" class="handRow"></div>
          </div>
        </div>
        <div class="rightCol">
          <div class="panel">
            <div class="title" id="aiDiscardTitle">DISCARD ‚Äî AI</div>
            <div id="aiDiscard" class="stackPiles"></div>
          </div>
          <div class="panel">
            <div class="title" id="youDiscardTitle">DISCARD ‚Äî You</div>
            <div id="youDiscard" class="stackPiles"></div>
          </div>
          <div class="panel logPanel">
            <div class="title" id="logTitle">Game log</div>
            <div id="log" class="log"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="orientTip" class="orientTip">Rotated for better fit</div>

<!-- Menu overlay -->
<div id="menu" class="menu" style="display:flex">
  <div class="cardmenu">
    <div class="muted" id="welcomeTxt">Welcome to F!RST</div>
    <div class="items">
      <button class="btn big" id="menuNewGame">New Game</button>
      <button class="btn big" id="menuRules">Rules</button>
    </div>
  </div>
</div>

<!-- Dice overlay -->
<div id="diceOverlay" class="diceOverlay">
  <div class="diceArea">
    <div>
      <div class="diceTxt" style="margin-bottom:6px;text-align:center" id="youTxt">You</div>
      <div id="dieYou" class="die">
        <div class="face">1</div><div class="face">2</div><div class="face">3</div>
        <div class="face">4</div><div class="face">5</div><div class="face">6</div>
      </div>
    </div>
    <div>
      <div class="diceTxt" style="margin-bottom:6px;text-align:center" id="aiTxt">AI</div>
      <div id="dieAI" class="die">
        <div class="face">1</div><div class="face">2</div><div class="face">3</div>
        <div class="face">4</div><div class="face">5</div><div class="face">6</div>
      </div>
    </div>
  </div>
</div>

<!-- Choice modal -->
<div class="modal" id="choiceModal">
  <div class="box">
    <div class="head"><div id="choiceTitle">Choose</div><div></div></div>
    <div class="body"><div id="choiceArea" class="choices"></div></div>
  </div>
</div>

<!-- Help/Rules modal -->
<div class="modal" id="helpModal">
  <div class="box">
    <div class="head"><div style="font-weight:800" id="rulesTitle">F!RST ‚Äî rules & cards</div><button class="btn" id="closeHelp">Close</button></div>
    <div class="body">
      <div class="note" style="font-size:14px; color:#dfe7ff" id="rulesBody">
        <!-- filled by i18n -->
      </div>
    </div>
  </div>
</div>

<!-- Victory modal -->
<div class="modal" id="winModal">
  <div class="box">
    <div class="head"><div style="font-weight:800" id="gameOverKey">Game Over</div><button class="btn" id="winClose">OK</button></div>
    <div class="body">
      <h3 id="winTitle">Victory!</h3>
      <div id="winMsg" class="msg">You completed a combo.</div>
      <div class="okbar" style="display:flex; justify-content:center; gap:8px; margin-top:8px">
        <button class="btn" id="winNew">New Game</button>
        <button class="btn" id="winMenu">Menu</button>
      </div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
/* =========================
   i18n
   ========================= */
const I18N = {
  en: {
    title:"F!RST ‚Äî flat ghibli",
    turnKey:"Turn", diceKey:"Dice", yourHandKey:"Your hand", aiHandKey:"AI hand", hidden:"hidden",
    btnFullscreen:"Fullscreen", btnMenu:"Menu", btnNew:"New Game", btnHelp:"?",
    welcome:"Welcome to F!RST", menuNew:"New Game", menuRules:"Rules",
    ai:"AI", you:"You",
    spaceAI:"SPACE ‚Äî AI", spaceYou:"SPACE ‚Äî You",
    discardAI:"DISCARD ‚Äî AI", discardYou:"DISCARD ‚Äî You",
    logTitle:"Game log", handTitle:"Your hand", handNote:"(tap a card to play; turn ends automatically)",
    rulesTitle:"F!RST ‚Äî rules & cards", close:"Close", gameOver:"Game Over",
    forbidChip:"Forbid active", forbidYou:"AI forbid: active", forbidAI:"Your forbid: active",
    winVictory:"Victory!", winDefeat:"Defeat", winDraw:"Draw",
    // Logs
    drewYou:"You drew a card.", drewAI:"AI drew a card.",
    overflowYou:"Your hand overflow: {card} ‚Üí DISCARD.", overflowAI:"AI's hand overflow: {card} ‚Üí DISCARD.",
    trapYou:"Trap: you discarded {card}.", trapAI:"Trap: AI discarded a card.",
    playedYou:"You played {card}.", playedAI:"AI played {card}.",
    forbidSetYou:"You forbade a letter for AI.", forbidSetAI:"AI forbade a letter for you.",
    forbidTrigYou:"Forbid triggered: your {card} went to DISCARD.", forbidTrigAI:"Forbid: AI's {card} went to DISCARD.",
    recoverYou:"You recovered {card} to hand.", recoverAI:"AI recovered a card to hand.",
    stealYou:"You moved opponent {card} to DISCARD.", stealAI:"AI stole your {card} to your DISCARD.",
    tYou:"You set a Trap (T): AI will discard 1 next turn.", tAI:"AI set a Trap (T): you will discard 1 next turn.",
    diceResultYou:"You: {you} ‚Ä¢ AI: {ai} ‚Äî You go first.", diceResultAI:"You: {you} ‚Ä¢ AI: {ai} ‚Äî AI goes first.",
    // Rules body
    rulesBody:`<b>Objective:</b> first to assemble <b>F I R S T</b>, or 5 copies of the same letter, in your SPACE.<br/><br/>
<b>Deck:</b> 50 cards per player (10√óF, 10√óI, 10√óR, 10√óS, 10√óT). Start hand: 5 cards. Dice decides who goes first.<br/><br/>
<b>Turn:</b> Draw 1 (except on the very first turn of the first player) ‚Üí play exactly 1 card ‚Üí resolve effect ‚Üí turn auto-ends. Hand limit: 7 (excess to discard). If you must draw and your deck is empty, you lose.<br/><br/>
<b>Cards:</b><br/>
‚Ä¢ <b>F</b> (<i>Forbid</i>): set a one-shot trap on a letter type; opponent‚Äôs next card of that type is sent to their DISCARD instead of entering SPACE.<br/>
‚Ä¢ <b>I</b> (<i>Increase</i>): draw 1 card.<br/>
‚Ä¢ <b>R</b> (<i>Recover</i>): return 1 card from your DISCARD to your hand.<br/>
‚Ä¢ <b>S</b> (<i>Steal</i>): move 1 card from opponent‚Äôs SPACE to their DISCARD.<br/>
‚Ä¢ <b>T</b> (<i>Trap</i>): on opponent‚Äôs next turn, after draw, they must discard 1 card (stacks).<br/>`
  },
  ru: {
    title:"F!RST ‚Äî –ø–ª–æ—Å–∫–∏–π ghibli",
    turnKey:"–•–æ–¥", diceKey:"–ö—É–±–∏–∫", yourHandKey:"–¢–≤–æ—è —Ä—É–∫–∞", aiHandKey:"–†—É–∫–∞ –ò–ò", hidden:"—Å–∫—Ä—ã—Ç–∞",
    btnFullscreen:"–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω", btnMenu:"–ú–µ–Ω—é", btnNew:"–ù–æ–≤–∞—è –∏–≥—Ä–∞", btnHelp:"?",
    welcome:"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ F!RST", menuNew:"–ù–æ–≤–∞—è –∏–≥—Ä–∞", menuRules:"–ü—Ä–∞–≤–∏–ª–∞",
    ai:"–ò–ò", you:"–¢—ã",
    spaceAI:"SPACE ‚Äî –ò–ò", spaceYou:"SPACE ‚Äî –¢—ã",
    discardAI:"DISCARD ‚Äî –ò–ò", discardYou:"DISCARD ‚Äî –¢—ã",
    logTitle:"–ñ—É—Ä–Ω–∞–ª –±–æ—è", handTitle:"–¢–≤–æ—è —Ä—É–∫–∞", handNote:"(–Ω–∞–∂–º–∏ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã —Å—ã–≥—Ä–∞—Ç—å; —Ö–æ–¥ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —Å–∞–º)",
    rulesTitle:"F!RST ‚Äî –ø—Ä–∞–≤–∏–ª–∞ –∏ –∫–∞—Ä—Ç—ã", close:"–ó–∞–∫—Ä—ã—Ç—å", gameOver:"–ö–æ–Ω–µ—Ü –∏–≥—Ä—ã",
    forbidChip:"–ë–ª–æ–∫ –∞–∫—Ç–∏–≤–µ–Ω", forbidYou:"–ë–ª–æ–∫ –ò–ò: –∞–∫—Ç–∏–≤–µ–Ω", forbidAI:"–¢–≤–æ–π –±–ª–æ–∫: –∞–∫—Ç–∏–≤–µ–Ω",
    winVictory:"–ü–æ–±–µ–¥–∞!", winDefeat:"–ü–æ—Ä–∞–∂–µ–Ω–∏–µ", winDraw:"–ù–∏—á—å—è",
    // Logs
    drewYou:"–¢—ã –≤–∑—è–ª –∫–∞—Ä—Ç—É.", drewAI:"–ò–ò –≤–∑—è–ª –∫–∞—Ä—Ç—É.",
    overflowYou:"–ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä—É–∫–∏: {card} ‚Üí DISCARD.", overflowAI:"–ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä—É–∫–∏ –ò–ò: {card} ‚Üí DISCARD.",
    trapYou:"–õ–æ–≤—É—à–∫–∞: —Ç—ã —Å–±—Ä–æ—Å–∏–ª {card}.", trapAI:"–õ–æ–≤—É—à–∫–∞: –ò–ò —Å–±—Ä–æ—Å–∏–ª –∫–∞—Ä—Ç—É.",
    playedYou:"–¢—ã —Å—ã–≥—Ä–∞–ª {card}.", playedAI:"–ò–ò —Å—ã–≥—Ä–∞–ª {card}.",
    forbidSetYou:"–¢—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±—É–∫–≤—É –¥–ª—è –ò–ò.", forbidSetAI:"–ò–ò –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±—É–∫–≤—É –¥–ª—è —Ç–µ–±—è.",
    forbidTrigYou:"–ë–ª–æ–∫ —Å—Ä–∞–±–æ—Ç–∞–ª: —Ç–≤–æ—è {card} —É—à–ª–∞ –≤ DISCARD.", forbidTrigAI:"–ë–ª–æ–∫: {card} –ò–ò —É—à–ª–∞ –≤ DISCARD.",
    recoverYou:"–¢—ã –≤–µ—Ä–Ω—É–ª {card} –≤ —Ä—É–∫—É.", recoverAI:"–ò–ò –≤–µ—Ä–Ω—É–ª –∫–∞—Ä—Ç—É –≤ —Ä—É–∫—É.",
    stealYou:"–¢—ã –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–∞—Ä—Ç—É –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ {card} –≤ DISCARD.", stealAI:"–ò–ò –æ—Ç–ø—Ä–∞–≤–∏–ª —Ç–≤–æ—é {card} –≤ DISCARD.",
    tYou:"–¢—ã –ø–æ—Å—Ç–∞–≤–∏–ª –õ–æ–≤—É—à–∫—É (T): –ò–ò —Å–±—Ä–æ—Å–∏—Ç 1 –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥.", tAI:"–ò–ò –ø–æ—Å—Ç–∞–≤–∏–ª –õ–æ–≤—É—à–∫—É (T): —Ç—ã —Å–±—Ä–æ—Å–∏—à—å 1 –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥.",
    diceResultYou:"–¢—ã: {you} ‚Ä¢ –ò–ò: {ai} ‚Äî –¢—ã —Ö–æ–¥–∏—à—å –ø–µ—Ä–≤—ã–º.", diceResultAI:"–¢—ã: {you} ‚Ä¢ –ò–ò: {ai} ‚Äî –ò–ò —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º.",
    // Rules
    rulesBody:`<b>–¶–µ–ª—å:</b> –ø–µ—Ä–≤—ã–º —Å–æ–±—Ä–∞—Ç—å <b>F I R S T</b> –∏–ª–∏ 5 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –±—É–∫–≤ –≤ —Å–≤–æ–µ–π SPACE.<br/><br/>
<b>–ö–æ–ª–æ–¥—ã:</b> –ø–æ 50 –∫–∞—Ä—Ç (10√óF, 10√óI, 10√óR, 10√óS, 10√óT). –í –Ω–∞—á–∞–ª–µ –ø–æ 5 –∫–∞—Ä—Ç. –ü–µ—Ä–≤—ã–π —Ö–æ–¥ —Ä–µ—à–∞–µ—Ç –∫—É–±–∏–∫.<br/><br/>
<b>–•–æ–¥:</b> –í–∑—è—Ç—å 1 (–∫—Ä–æ–º–µ —Å–∞–º–æ–≥–æ –ø–µ—Ä–≤–æ–≥–æ —Ö–æ–¥–∞ –ø–µ—Ä–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞) ‚Üí —Å—ã–≥—Ä–∞—Ç—å —Ä–æ–≤–Ω–æ 1 –∫–∞—Ä—Ç—É ‚Üí –ø—Ä–∏–º–µ–Ω–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç ‚Üí —Ö–æ–¥ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –õ–∏–º–∏—Ç —Ä—É–∫–∏: 7 (–ª–∏—à–Ω–µ–µ ‚Äî –≤ DISCARD). –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–∑—è—Ç—å, –∞ –∫–æ–ª–æ–¥–∞ –ø—É—Å—Ç–∞ ‚Äî –ø–æ—Ä–∞–∂–µ–Ω–∏–µ.<br/><br/>
<b>–ö–∞—Ä—Ç—ã:</b><br/>
‚Ä¢ <b>F</b> (<i>Forbid</i>): –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω—ã–π –±–ª–æ–∫ –±—É–∫–≤—ã; —Å–ª–µ–¥—É—é—â–∞—è –∫–∞—Ä—Ç–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ —ç—Ç–æ–π –±—É–∫–≤—ã –ø–æ–π–¥—ë—Ç –≤ DISCARD –≤–º–µ—Å—Ç–æ SPACE.<br/>
‚Ä¢ <b>I</b> (<i>Increase</i>): –≤–æ–∑—å–º–∏ 1 –∫–∞—Ä—Ç—É.<br/>
‚Ä¢ <b>R</b> (<i>Recover</i>): –≤–µ—Ä–Ω–∏ 1 –∫–∞—Ä—Ç—É –∏–∑ DISCARD –≤ —Ä—É–∫—É.<br/>
‚Ä¢ <b>S</b> (<i>Steal</i>): —É–±–µ—Ä–∏ 1 –∫–∞—Ä—Ç—É –∏–∑ SPACE –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –≤ –µ–≥–æ DISCARD.<br/>
‚Ä¢ <b>T</b> (<i>Trap</i>): –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫ –ø–æ—Å–ª–µ –≤–∑—è—Ç–∏—è –æ–±—è–∑–∞–Ω —Å–±—Ä–æ—Å–∏—Ç—å 1 –∫–∞—Ä—Ç—É (—Å—Ç–µ–∫–∞–µ—Ç—Å—è).<br/>`
  }
};
let LANG = 'en';
function t(key, params={}){
  let s = (I18N[LANG] && I18N[LANG][key]) || key;
  for(const k in params){ s = s.replaceAll('{'+k+'}', params[k]); }
  return s;
}
function applyTexts(){
  document.getElementById('titleTxt').textContent = t('title');
  document.getElementById('turnKey').textContent = t('turnKey');
  document.getElementById('diceKey').textContent = t('diceKey');
  document.getElementById('yourHandKey').textContent = t('yourHandKey');
  document.getElementById('aiHandKey').textContent = t('aiHandKey');
  document.getElementById('hiddenKey').textContent = t('hidden');
  document.getElementById('toMenuBtn').textContent = t('btnMenu');
  document.getElementById('restartBtn').textContent = t('btnNew');
  document.getElementById('fullBtn').textContent = t('btnFullscreen');
  document.getElementById('aiSpaceTitle').textContent = t('spaceAI');
  document.getElementById('youSpaceTitle').textContent = t('spaceYou');
  document.getElementById('aiDiscardTitle').textContent = t('discardAI');
  document.getElementById('youDiscardTitle').textContent = t('discardYou');
  document.getElementById('logTitle').textContent = t('logTitle');
  document.getElementById('yourHandTitle').firstChild.textContent = t('handTitle') + ' ';
  document.getElementById('handNote').textContent = t('handNote');
  document.getElementById('welcomeTxt').textContent = t('welcome');
  document.getElementById('menuNewGame').textContent = t('menuNew');
  document.getElementById('menuRules').textContent = t('menuRules');
  document.getElementById('youTxt').textContent = t('you');
  document.getElementById('aiTxt').textContent = t('ai');
  document.getElementById('rulesTitle').textContent = t('rulesTitle');
  document.getElementById('rulesBody').innerHTML = t('rulesBody');
  document.getElementById('gameOverKey').textContent = t('gameOver');
  document.getElementById('winNew').textContent = t('menuNew');
  document.getElementById('winMenu').textContent = t('btnMenu');
  document.getElementById('youForbidChip').textContent = t('forbidChip');
  document.getElementById('aiForbidChip').textContent = t('forbidChip');
  document.getElementById('forbidAIPill').textContent = t('forbidAI');
  document.getElementById('forbidYouPill').textContent = t('forbidYou');
  document.getElementById('langBtn').textContent = LANG==='en'?'üá¨üáß EN':'üá∑üá∫ RU';
}

/* =========================
   Game state
   ========================= */
const TYPES=['F','I','R','S','T'];
let G=null;

function sideState(){ return { deck: buildDeck(), hand: [], space: [], discard: [] }; }
function buildDeck(){ const d=[]; for(let i=0;i<10;i++) for(const t of TYPES) d.push(t); return d; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

function newGame(){
  G={ turn:null, firstPlayer:null, firstTurnDone:false,
      you:sideState(), ai:sideState(),
      traps:{ forbidYou:null, forbidAI:null, tNextYou:0, tNextAI:0 },
      over:false, log:[] };
  shuffle(G.you.deck); shuffle(G.ai.deck);
  draw('you',5); draw('ai',5);
  openDiceAndDecideFirstPlayer();
  render();
}

function setHUD(){
  document.getElementById('youHandCount').textContent=G.you.hand.length;
  document.getElementById('aiHandCount').textContent=G.ai.hand.length;
  document.getElementById('turnLbl').textContent= G.over? t('gameOver') : (G.turn==='you'? t('you') : t('ai'));
  // forbid pills (no letter reveal)
  const y=!!G.traps.forbidAI, a=!!G.traps.forbidYou;
  const yP=document.getElementById('forbidAIPill');
  const aP=document.getElementById('forbidYouPill');
  yP.style.display = y?'inline-block':'none';
  aP.style.display = a?'inline-block':'none';
  document.getElementById('youForbidChip').style.display = y?'inline-block':'none';
  document.getElementById('aiForbidChip').style.display  = a?'inline-block':'none';
}

function updateOrientation(){
  const portrait=window.innerHeight>window.innerWidth;
  const rot=document.getElementById('rot');
  if(portrait){
    document.body.classList.add('portrait');
    const w=window.innerWidth, h=window.innerHeight;
    const scale=Math.min(h/w, 1);
    rot.style.setProperty('--scale', Math.max(0.88, scale).toString());
    document.getElementById('orientTip').style.display='block';
  }else{
    document.body.classList.remove('portrait');
    document.getElementById('orientTip').style.display='none';
  }
}
window.addEventListener('resize', updateOrientation);

/* =========================
   Rendering
   ========================= */
function cardEl(letter, opts={}){
  const d=document.createElement('div');
  d.className='card'+(opts.clickable?' clickable':'');
  const span=document.createElement('div'); span.className='L '+letter; span.textContent=letter;
  d.appendChild(span);
  if(opts.clickable && opts.onClick) d.addEventListener('click', opts.onClick);
  return d;
}
function zoneEl(id){ return document.getElementById(id); }

function render(){
  setHUD();
  // SPACE AI / YOU
  const aiS=zoneEl('aiSpace'); aiS.innerHTML='';
  G.ai.space.forEach(c=> aiS.appendChild(cardEl(c)));
  const youS=zoneEl('youSpace'); youS.innerHTML='';
  G.you.space.forEach(c=> youS.appendChild(cardEl(c)));
  // HAND
  const hand=zoneEl('youHand'); hand.innerHTML='';
  G.you.hand.forEach((c,i)=> hand.appendChild(cardEl(c,{clickable:G.turn==='you' && !G.over, onClick:()=>playFromHand(i)})));
  // DISCARD
  renderDiscard('aiDiscard', G.ai.discard);
  renderDiscard('youDiscard', G.you.discard);
  // Forbid FX on F cards only
  updateForbidFX();
}

function updateForbidFX(){
  // Clear previous
  document.querySelectorAll('.forbidFx').forEach(el=> el.classList.remove('forbidFx'));
  // If you set a forbid on AI (forbidAI present) -> highlight your latest F
  if(G.traps.forbidAI){
    const idx = lastIndexOf(G.you.space, 'F');
    const zone = document.getElementById('youSpace');
    if(idx>=0 && zone.children[idx]) zone.children[idx].classList.add('forbidFx');
  }
  // If AI set a forbid on you -> highlight AI's latest F
  if(G.traps.forbidYou){
    const idx = lastIndexOf(G.ai.space, 'F');
    const zone = document.getElementById('aiSpace');
    if(idx>=0 && zone.children[idx]) zone.children[idx].classList.add('forbidFx');
  }
  // Chips (text set via i18n)
  document.getElementById('youForbidChip').style.display = G.traps.forbidAI?'inline-block':'none';
  document.getElementById('aiForbidChip').style.display  = G.traps.forbidYou?'inline-block':'none';
}

function lastIndexOf(arr, val){ for(let i=arr.length-1;i>=0;i--){ if(arr[i]===val) return i; } return -1; }

function renderDiscard(containerId, discardArr){
  const box=document.getElementById(containerId); box.innerHTML='';
  const counts={F:0,I:0,R:0,S:0,T:0}; discardArr.forEach(x=>counts[x]++);
  const pile=document.createElement('div'); pile.className='pile';
  TYPES.forEach(t=>{ if(counts[t]===0) return; const m=document.createElement('div'); m.className='mini'; const b=document.createElement('b'); b.textContent=t; b.style.color=letterColor(t); m.appendChild(b); pile.appendChild(m); });
  const cnt=document.createElement('div'); cnt.className='count'; cnt.textContent=discardArr.length;
  pile.appendChild(cnt); box.appendChild(pile);
}
function letterColor(l){ return l==='F'?'#9cc8ff':l==='I'?'#a9ffcf':l==='R'?'#ffd195':l==='S'?'#ff9aa4':'#c6b3ff'; }

function logAddRaw(s){
  G.log.push(s);
  const el=document.getElementById('log');
  const div=document.createElement('div'); div.textContent=s; div.className='entry';
  el.appendChild(div); el.scrollTop=el.scrollHeight;
}
function logAdd(key, params){ logAddRaw(t(key, params||{})); }

/* =========================
   Flow
   ========================= */
function draw(side,n){
  const S=(side==='you')?G.you:G.ai;
  for(let i=0;i<n;i++){
    if(S.deck.length===0){ defeat(side); return; }
    const c=S.deck.pop(); S.hand.push(c);
    logAdd(side==='you'?'drewYou':'drewAI');
    enforceHandLimit(side);
    if(G.over) return;
  }
}
function enforceHandLimit(side){
  const S=side==='you'?G.you:G.ai;
  while(S.hand.length>7){
    const overflow=S.hand.pop();
    S.discard.push(overflow);
    logAdd(side==='you'?'overflowYou':'overflowAI', {card:overflow});
  }
  render();
}

function startTurn(){
  if(G.over) return;
  setHUD();
  const side=G.turn;
  const skip=(!G.firstTurnDone && G.turn===G.firstPlayer);
  if(!skip){ draw(side,1); if(G.over) return; }
  if(!G.firstTurnDone) G.firstTurnDone=true;

  if(side==='you' && G.traps.tNextYou>0){
    if(G.you.hand.length>0){
      chooseIndex('Trap (T): choose a card to discard', G.you.hand, (idx)=>{
        const dumped=G.you.hand.splice(idx,1)[0];
        G.you.discard.push(dumped);
        animateFromSpaceOrHand('you','hand',idx, document.getElementById('youDiscard'));
        logAdd('trapYou',{card:dumped}); render(); G.traps.tNextYou=0;
      });
      return;
    }else G.traps.tNextYou=0;
  }
  if(side==='ai' && G.traps.tNextAI>0){
    if(G.ai.hand.length>0){
      const dumpedIdx=Math.floor(Math.random()*G.ai.hand.length);
      const dumped=G.ai.hand.splice(dumpedIdx,1)[0];
      G.ai.discard.push(dumped);
      animateFromSpaceOrHand('ai','hand',dumpedIdx, document.getElementById('aiDiscard'));
      logAdd('trapAI'); render();
    }
    G.traps.tNextAI=0;
  }

  render();
  if(side==='ai'){ setTimeout(aiPlay, 800+Math.random()*600); }
}

function endTurn(){ if(G.over) return; G.turn=(G.turn==='you')?'ai':'you'; render(); setTimeout(startTurn,380); }

function defeat(side){
  if(G.over) return; G.over=true;
  showWin(side==='you'?t('ai'):t('you'), side==='you'? 'Your deck was empty on a required draw.' : 'AI had no cards to draw.');
}

function playFromHand(index){
  if(G.over || G.turn!=='you') return;
  const letter=G.you.hand[index]; if(!letter) return;
  if(G.traps.forbidYou===letter){
    G.traps.forbidYou=null;
    const src=pickHandCardEl(index);
    G.you.discard.push(letter); G.you.hand.splice(index,1);
    animateFly(src, document.getElementById('youDiscard'));
    triggerForbidFlash('you', index);
    logAdd('forbidTrigYou',{card:letter});
    render();
    if(!checkWin()) endTurn(); return;
  }
  const src=pickHandCardEl(index);
  G.you.hand.splice(index,1); G.you.space.push(letter);
  animateFly(src, document.getElementById('youSpace'));
  logAdd('playedYou',{card:letter}); render();
  resolveEffect('you', letter, ()=>{ if(!checkWin()) endTurn(); });
}

function resolveEffect(side, letter, done){
  if(letter==='F'){
    chooseType('Choose a letter to forbid', TYPES, (tChosen)=>{
      if(side==='you'){ G.traps.forbidAI=tChosen; logAdd('forbidSetYou'); }
      else { G.traps.forbidYou=tChosen; logAdd('forbidSetAI'); }
      render(); done();
    });
    return;
  }
  if(letter==='I'){ draw(side,1); done(); return; }
  if(letter==='R'){
    const S=side==='you'?G.you:G.ai;
    if(S.discard.length===0){ done(); return; }
    chooseType('Recover: choose a letter from your DISCARD', uniqueLetters(S.discard), (pick)=>{
      const idx=S.discard.lastIndexOf(pick);
      if(idx>=0){
        const c=S.discard.splice(idx,1)[0];
        S.hand.push(c);
        if(side==='you') animateFromDiscardTo('you','hand', pick);
        else animateFromDiscardTo('ai','space', pick);
        logAdd(side==='you'?'recoverYou':'recoverAI',{card:c}); enforceHandLimit(side);
      }
      render(); done();
    });
    return;
  }
  if(letter==='S'){
    const O=side==='you'?G.ai:G.you;
    if(O.space.length===0){ done(); return; }
    chooseIndex('Steal: choose a card from opponent SPACE', O.space, (i)=>{
      animateFromSpaceOrHand(side==='you'?'ai':'you','space',i, side==='you'?document.getElementById('aiDiscard'):document.getElementById('youDiscard'));
      const removed=O.space.splice(i,1)[0]; O.discard.push(removed);
      logAdd(side==='you'?'stealYou':'stealAI',{card:removed});
      // If F removed, forbid FX will disappear on next render
      render(); done();
    });
    return;
  }
  if(letter==='T'){
    if(side==='you'){ G.traps.tNextAI++; logAdd('tYou'); }
    else { G.traps.tNextYou++; logAdd('tAI'); }
    done(); return;
  }
  done();
}

function uniqueLetters(arr){ return Array.from(new Set(arr)); }

function aiPlay(){
  if(G.over || G.turn!=='ai') return;
  const hand=G.ai.hand.slice(); if(hand.length===0){ endTurn(); return; }
  let idx=-1;
  if(G.you.space.length>0 && hand.includes('S')) idx=hand.indexOf('S');
  if(idx<0 && G.ai.discard.length>0 && hand.includes('R')) idx=hand.indexOf('R');
  if(idx<0 && hand.includes('F')) idx=hand.indexOf('F');
  if(idx<0 && hand.includes('T')) idx=hand.indexOf('T');
  if(idx<0 && hand.includes('I')) idx=hand.indexOf('I');
  if(idx<0) idx=0;
  const letter=hand[idx];
  if(G.traps.forbidAI===letter){
    G.traps.forbidAI=null;
    const src=pickAiHandCardEl(idx);
    G.ai.discard.push(letter); G.ai.hand.splice(idx,1);
    animateFly(src, document.getElementById('aiDiscard'));
    triggerForbidFlash('ai', idx);
    logAdd('forbidTrigAI',{card:letter});
    render(); if(!checkWin()) endTurn(); return;
  }
  const src=pickAiHandCardEl(idx);
  G.ai.hand.splice(idx,1); G.ai.space.push(letter);
  animateFly(src, document.getElementById('aiSpace'));
  logAdd('playedAI',{card:letter}); render();
  if(letter==='F'){
    const tChosen=pickMostType(G.you.space) || TYPES[Math.floor(Math.random()*5)];
    G.traps.forbidYou=tChosen; logAdd('forbidSetAI'); render(); finalize(); return;
  }
  if(letter==='I'){ draw('ai',1); finalize(); return; }
  if(letter==='R'){
    if(G.ai.discard.length>0){
      const c=G.ai.discard.pop(); G.ai.hand.push(c);
      animateFromDiscardTo('ai','space', c);
      logAdd('recoverAI'); enforceHandLimit('ai');
    }
    finalize(); return;
  }
  if(letter==='S'){
    if(G.you.space.length>0){
      const i=G.you.space.length-1;
      animateFromSpaceOrHand('you','space',i, document.getElementById('youDiscard'));
      const removed=G.you.space.pop(); G.you.discard.push(removed);
      logAdd('stealAI',{card:removed}); render();
    }
    finalize(); return;
  }
  if(letter==='T'){ G.traps.tNextYou++; logAdd('tAI'); finalize(); return; }
  finalize();
  function finalize(){ if(!checkWin()) endTurn(); }
}

function triggerForbidFlash(side, indexInHand){
  // Visual flash where the blocked card left from
  const panel = side==='you' ? document.getElementById('panelYouSpace') : document.getElementById('panelAiSpace');
  const flash=document.createElement('div'); flash.className='triggerFlash';
  panel.querySelector('.boardFlat').appendChild(flash);
  setTimeout(()=>{ if(flash.parentNode) flash.parentNode.removeChild(flash); }, 800);
}

function pickMostType(arr){ const m={}; for(const x of arr){m[x]=(m[x]||0)+1;} let b=null,v=-1; for(const [k,c] of Object.entries(m)){ if(c>v){b=k; v=c;} } return b; }

/* =========================
   Dice
   ========================= */
function openDiceAndDecideFirstPlayer(){
  const overlay=document.getElementById('diceOverlay'); overlay.style.display='flex';
  let you=rand1to6(), ai=rand1to6(); if(you===ai){ do{ you=rand1to6(); ai=rand1to6(); }while(you===ai); }
  animateDice('dieYou',you); animateDice('dieAI',ai);
  setTimeout(()=>{
    G.firstPlayer= you>ai?'you':'ai';
    document.getElementById('diceLbl').textContent = (you>ai)? t('diceResultYou',{you,you:you, ai:ai}).replace('{you}',you).replace('{ai}',ai) : t('diceResultAI',{you:you, ai:ai}).replace('{you}',you).replace('{ai}',ai);
    overlay.style.display='none'; G.turn=G.firstPlayer; render(); startTurn();
  },1700);
}
function rand1to6(){ return 1+Math.floor(Math.random()*6); }
function animateDice(id,val){
  const die=document.getElementById(id); const target=faceRotation(val);
  if(window.gsap && gsap.to){ const tl=gsap.timeline(); tl.to(die,{duration:0.6,rotateX:360,rotateY:360,ease:"power2.out"}).to(die,{duration:0.7,rotateX:target.x,rotateY:target.y,ease:"power3.out"}); }
  else { const t0=performance.now(),dur=700; function step(now){ const p=Math.min(1,(now-t0)/dur); const ex=target.x*p, ey=target.y*p; die.style.transform=`rotateX(${ex}deg) rotateY(${ey}deg)`; if(p<1) requestAnimationFrame(step); } requestAnimationFrame(step); }
}
function faceRotation(v){ switch(v){ case 1:return{x:0,y:0}; case 2:return{x:0,y:-90}; case 3:return{x:0,y:180}; case 4:return{x:0,y:90}; case 5:return{x:-90,y:0}; case 6:return{x:90,y:0}; } return{x:0,y:0}; }

/* =========================
   Anim helpers
   ========================= */
function pickHandCardEl(index){ const hand=document.getElementById('youHand'); return hand.children[index]; }
function pickAiHandCardEl(index){ return null; }

function makeGhostLetter(letter){
  const g=document.createElement('div'); g.className='card';
  const span=document.createElement('div'); span.className='L '+letter; span.textContent=letter;
  g.appendChild(span); g.style.position='fixed'; g.style.margin='0'; g.style.zIndex='90'; g.style.pointerEvents='none'; return g;
}
function animateFly(fromEl,toContainer){
  if(!fromEl||!toContainer){ animatePopTo(toContainer); return; }
  const rectFrom=fromEl.getBoundingClientRect(), rectTo=toContainer.getBoundingClientRect();
  const targetX=rectTo.left+rectTo.width/2-rectFrom.left-rectFrom.width/2;
  const targetY=rectTo.top+rectTo.height/2-rectFrom.top-rectFrom.height/2;
  const ghost=fromEl.cloneNode(true);
  ghost.style.position='fixed'; ghost.style.left=rectFrom.left+'px'; ghost.style.top=rectFrom.top+'px'; ghost.style.margin='0'; ghost.style.zIndex='90'; ghost.style.pointerEvents='none';
  document.body.appendChild(ghost);
  if(window.gsap && gsap.to){ gsap.to(ghost,{duration:0.55,x:targetX,y:targetY,scale:0.9,rotation:(Math.random()*10-5),ease:"power3.inOut",onComplete:()=>document.body.removeChild(ghost)}); }
  else { const t0=performance.now(),dur=550; function step(now){ const p=Math.min(1,(now-t0)/dur); const x=targetX*p, y=targetY*p, s=1-0.1*p; ghost.style.transform=`translate(${x}px, ${y}px) scale(${s})`; if(p<1) requestAnimationFrame(step); else document.body.removeChild(ghost);} requestAnimationFrame(step); }
}
function animatePopTo(container){
  if(!container) return;
  if(window.gsap && gsap.fromTo){ gsap.fromTo(container,{scale:0.96},{duration:0.22,scale:1,ease:"power2.out"}); }
  else { container.style.transition='transform .22s ease-out'; container.style.transform='scale(0.96)'; setTimeout(()=>{container.style.transform='scale(1)';},10); }
}
function animateFromSpaceOrHand(side,area,index,targetContainer){
  const zoneId= side==='you' ? (area==='space'?'youSpace':'youHand') : (area==='space'?'aiSpace':'aiHandHidden');
  const zone=document.getElementById(zoneId);
  if(!zone||!zone.children||index<0||index>=zone.children.length){ animatePopTo(targetContainer); return; }
  const fromEl=zone.children[index]; animateFly(fromEl, targetContainer);
}
function animateFromDiscardTo(side,dest,letter){
  const from=document.getElementById(side==='you'?'youDiscard':'aiDiscard');
  const to  =document.getElementById(side==='you'?'youHand':'aiSpace');
  if(!from||!to) return;
  const rectFrom=from.getBoundingClientRect(), rectTo=to.getBoundingClientRect();
  const ghost=makeGhostLetter(letter||'R');
  ghost.style.left=(rectFrom.left+rectFrom.width*0.3)+'px';
  ghost.style.top =(rectFrom.top +rectFrom.height*0.3)+'px';
  document.body.appendChild(ghost);
  const dx=rectTo.left+rectTo.width/2-(rectFrom.left+rectFrom.width*0.3)-ghost.offsetWidth/2;
  const dy=rectTo.top +rectTo.height/2-(rectFrom.top +rectFrom.height*0.3)-ghost.offsetHeight/2;
  if(window.gsap && gsap.to){ gsap.fromTo(ghost,{opacity:0.85,scale:0.88},{duration:0.6,x:dx,y:dy,scale:1,opacity:0.95,ease:"power3.out",onComplete:()=>document.body.removeChild(ghost)}); }
  else { const t0=performance.now(),dur=600; function step(now){ const p=Math.min(1,(now-t0)/dur); const x=dx*p,y=dy*p,s=0.88+0.12*p; ghost.style.transform=`translate(${x}px, ${y}px) scale(${s})`; if(p<1) requestAnimationFrame(step); else document.body.removeChild(ghost);} requestAnimationFrame(step); }
}

/* =========================
   Choice modals
   ========================= */
function chooseType(title,options,cb){
  const modal=document.getElementById('choiceModal'); document.getElementById('choiceTitle').textContent=title;
  const area=document.getElementById('choiceArea'); area.innerHTML='';
  options.forEach(o=>{ const b=document.createElement('button'); b.className='choice'; b.textContent=o; b.addEventListener('click',()=>{ modal.style.display='none'; cb(o);}); area.appendChild(b); });
  modal.style.display='flex';
}
function chooseIndex(title,list,cb){
  const modal=document.getElementById('choiceModal'); document.getElementById('choiceTitle').textContent=title;
  const area=document.getElementById('choiceArea'); area.innerHTML='';
  list.forEach((letter,idx)=>{ const b=document.createElement('button'); b.className='choice'; b.textContent=`${idx+1}) ${letter}`; b.addEventListener('click',()=>{ modal.style.display='none'; cb(idx);}); area.appendChild(b); });
  modal.style.display='flex';
}

/* =========================
   Win check & modal
   ========================= */
function checkWin(){
  function hasFIRST(space){ const set=new Set(space); return TYPES.every(t=>set.has(t)); }
  function hasFiveSame(space){ const m={F:0,I:0,R:0,S:0,T:0}; space.forEach(c=>m[c]++); return Object.values(m).some(v=>v>=5); }
  const youWin=hasFIRST(G.you.space) || hasFiveSame(G.you.space);
  const aiWin =hasFIRST(G.ai.space)  || hasFiveSame(G.ai.space);
  if(youWin || aiWin){
    G.over=true;
    const winner= youWin && !aiWin ? 'You' : (!youWin && aiWin ? 'AI' : 'Both');
    const msg = youWin && !aiWin ? 'You completed a combo.' : (!youWin && aiWin ? 'AI completed a combo.' : 'Both completed a combo.');
    const youPanel=document.getElementById('panelYouSpace'), aiPanel=document.getElementById('panelAiSpace');
    youPanel.classList.toggle('winGlow', youWin); youPanel.classList.toggle('loseGlow', !youWin && aiWin);
    aiPanel.classList.toggle('winGlow', aiWin);   aiPanel.classList.toggle('loseGlow', !aiWin && youWin);
    setTimeout(()=> showWin(winner,msg), 350); return true;
  }
  return false;
}

function showWin(winner,msg){
  document.getElementById('winTitle').textContent= winner==='Both'? t('winDraw') : (winner==='You'? t('winVictory') : t('winDefeat'));
  document.getElementById('winMsg').textContent=msg;
  document.getElementById('winModal').style.display='flex';
}

/* =========================
   Menu & Help & Fullscreen & Lang
   ========================= */
document.getElementById('menuNewGame').addEventListener('click', ()=>{
  document.getElementById('menu').style.display='none'; newGame();
});
document.getElementById('menuRules').addEventListener('click', ()=>{
  document.getElementById('menu').style.display='none';
  document.getElementById('helpModal').style.display='flex';
});
document.getElementById('toMenuBtn').addEventListener('click', ()=>{
  document.getElementById('menu').style.display='flex';
});
document.getElementById('restartBtn').addEventListener('click', ()=>{
  document.getElementById('log').innerHTML=''; newGame();
});
document.getElementById('helpBtn').addEventListener('click', ()=>{
  document.getElementById('helpModal').style.display='flex';
});
document.getElementById('closeHelp').addEventListener('click', ()=>{
  document.getElementById('helpModal').style.display='none';
});
document.getElementById('helpModal').addEventListener('click', (e)=>{
  if(e.target.id==='helpModal') e.currentTarget.style.display='none';
});
document.getElementById('choiceModal').addEventListener('click', (e)=>{
  if(e.target.id==='choiceModal') e.currentTarget.style.display='none';
});
document.getElementById('winClose').addEventListener('click', ()=>{
  document.getElementById('winModal').style.display='none';
});
document.getElementById('winMenu').addEventListener('click', ()=>{
  document.getElementById('winModal').style.display='none';
  document.getElementById('menu').style.display='flex';
});
document.getElementById('winNew').addEventListener('click', ()=>{
  document.getElementById('winModal').style.display='none';
  document.getElementById('log').innerHTML=''; newGame();
});
document.getElementById('fullBtn').addEventListener('click', ()=>{
  const el=document.documentElement;
  if(!document.fullscreenElement && el.requestFullscreen){ el.requestFullscreen(); }
  else if(document.exitFullscreen){ document.exitFullscreen(); }
});
document.getElementById('langBtn').addEventListener('click', ()=>{
  LANG = (LANG==='en')?'ru':'en';
  applyTexts(); render();
});

/* =========================
   Init
   ========================= */
applyTexts();
updateOrientation(); // init; game starts from menu
</script>
</body>
</html>
