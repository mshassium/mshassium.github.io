<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>F!RST ‚Äî v18</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>
<style>
:root{ --zone-k: 0.78; --zone-c: 20px;
  --page-max: 1280px;
  --bg:#0c1014;
  --panel-b:#232b39;
  --text:#f2f5fb; --muted:#aab3c2;
  --accent:#8fb1ff;
  --outline:#4a5a84;
  --ring:#3aa1ff80;
  --forbid:#ffd36b;
  --card-w:clamp(84px, 11vw, 112px);
  --card-w-hand: var(--card-w);
  --gap:12px;
}
*{box-sizing:border-box}
html,body{height:100svh;height:100dvh;margin:0;background:var(--bg);color:var(--text);
  font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif; overflow:hidden; overscroll-behavior:none}
.wrap{position:relative;width:100%;height:100%;display:flex;flex-direction:column;overflow:hidden}
.center{max-width:var(--page-max);margin:0 auto;position:relative}

/* ===== Header ===== */
header{position:sticky;top:0;z-index:120;display:flex;align-items:center;justify-content:center;gap:10px;padding:8px 14px;
  background:linear-gradient(180deg,#0c1014,#0c1014cc 80%, transparent);backdrop-filter:saturate(110%) blur(4px)}
header .center{display:flex;align-items:center;justify-content:space-between;gap:10px;width:100%}
.titlebar{display:flex;align-items:center;gap:8px;min-width:0;white-space:nowrap;overflow-x:auto;scrollbar-width:none}
.titlebar::-webkit-scrollbar{display:none}
h1{font-size:18px;margin:0;color:var(--accent);white-space:nowrap}
.pill{padding:6px 10px;border-radius:999px;border:1px solid var(--panel-b);background:#0f1422b3;color:#dae6ff;font-size:12px;backdrop-filter:blur(4px);white-space:nowrap}
.btn{background:#1a2233;color:var(--text);border:1px solid var(--panel-b);border-radius:10px;padding:8px 12px;cursor:pointer}
.btn:hover{background:#1f2a40}
.icon-btn{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-weight:900}
.controls{display:flex;gap:8px;align-items:center}
#hamburger{display:none;width:40px;height:36px;border-radius:10px;font-weight:900}
.quickMenu{position:fixed;right:10px;top:54px;display:none;flex-direction:column;gap:8px;background:#0f1728;border:1px solid #2d3754;border-radius:12px;padding:10px;box-shadow:0 16px 36px rgba(0,0,0,.55);z-index:300}
.quickMenu .btn{width:200px;text-align:left}

/* ===== Layout ===== */
.boardShell{position:relative;flex:1;overflow:hidden}
.boardGrid{position:absolute;inset:48px 0 0 0;display:grid;grid-template-columns:1fr minmax(260px,320px);gap:var(--gap);overflow:hidden;padding:0 var(--gap) var(--gap) var(--gap);transform-origin:top left}

.leftCol{display:grid;grid-template-rows:auto auto auto;gap:var(--gap);min-width:0;min-height:0}
.rightCol{display:grid;grid-template-rows:auto auto 1fr;gap:var(--gap);min-width:0;min-height:0}

.panel{background:linear-gradient(180deg,#121722,#0e1420);border:1px solid var(--panel-b);border-radius:14px;padding:10px;
  box-shadow:0 10px 16px rgba(0,0,0,.22), inset 0 1px 0 #ffffff10;overflow:hidden;min-height:0;display:flex;flex-direction:column}
.title{font-weight:800;margin-bottom:6px;font-size:13px;color:#dbe5ff;letter-spacing:.3px;text-shadow:0 1px 0 #000;
  display:flex;align-items:center;gap:8px;white-space:nowrap}
.chip{font-size:11px;padding:2px 6px;border:1px solid #2f3a56;border-radius:999px;background:#101828;color:#dbe5ff}
.note{font-size:12px;color:var(--muted)}

/* Space panels */
.boardFlat{position:relative;width:100%;border-radius:14px;background:linear-gradient(180deg,#182132,#0d1422);
  border:1px solid #2d3a55;box-shadow:inset 0 0 0 2px #0b101a, 0 10px 24px rgba(0,0,0,.30);overflow:hidden;contain:layout paint size;
  height: calc(var(--card-w));} /* narrower */
.zone{position:absolute;inset:6px;display:flex;gap:10px;flex-wrap:nowrap;align-items:flex-start;overflow-x:auto;overflow-y:hidden;border-radius:10px;clip-path:inset(0 round 10px)}

/* Cards */
.card{width:var(--card-w);height:calc(var(--card-w)*0.72);border-radius:12px;border:1px solid #2f3850;
  background:linear-gradient(180deg,#1d2536,#141b2a);display:flex;align-items:center;justify-content:center;position:relative;
  box-shadow:0 8px 14px rgba(0,0,0,.35), inset 0 0 0 2px #c8d2ee22;transition:transform .12s ease-out, box-shadow .12s ease-out}
.card.hand{width:var(--card-w-hand);height:var(--card-w-hand)}
.card.clickable{cursor:pointer}
.card.clickable:hover{box-shadow:0 10px 16px rgba(0,0,0,.4), 0 0 0 2px var(--outline) inset;transform:translateY(-2px)}
.L{font-size:clamp(32px,5.8vw,52px);font-weight:1000;letter-spacing:2px;line-height:1;text-shadow:0 1px 0 #000}
.card.hand .L{font-size:calc(0.576 * (clamp(32px,5.8vw,52px)));}
.L.F{color:#9cc8ff}.L.I{color:#a9ffcf}.L.R{color:#ffd195}.L.S{color:#ff9aa4}.L.T{color:#c6b3ff}

/* Forbid FX as card border */
.forbidFx{ border-color: var(--forbid) !important; box-shadow: 0 0 0 2px #ffd36b55 inset, 0 0 18px #ffd36b33; }
.badge{position:absolute;top:4px;right:4px;background:#0f1422;border:1px solid #2a3244;color:#1eeb8f;padding:0 4px;font-size:10px;border-radius:9px;z-index:2;box-shadow:0 3px 8px rgba(0,0,0,.35)}

/* Turn highlight */
.activeTurn{outline:2px solid var(--ring);box-shadow:0 0 0 6px #3aa1ff14 inset, 0 0 0 2px var(--ring) inset}

/* Discard piles */
.stackPiles{display:grid;gap:10px;overflow:hidden}
.pile{position:relative;display:inline-flex;align-items:flex-end;gap:10px;flex-wrap:nowrap;padding-left:24px;max-width:100%}
.pile .mini{width:30px;height:42px;background:linear-gradient(180deg,#1b2232,#111826);border:1px solid #2f3850;border-radius:7px;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 10px rgba(0,0,0,.28);flex:0 0 auto}
.pile .mini b{font-size:18px;line-height:1;text-shadow:0 1px 0 #000}
.pile .mini + .mini{margin-left:-14px}
.pile .count{position:absolute;top:2px;right:2px;background:#0f1422;border:1px solid #2a3244;color:#dbe5ff;padding:2px 6px;font-size:12px;border-radius:999px;z-index:3}

/* Hand */
.handPanel{padding:10px}
.handRow{display:flex;gap:8px;flex-wrap:nowrap;align-items:center;padding:4px;overflow:hidden;scrollbar-width:none}

/* Log */
.logPanel{min-height:0;display:flex;flex-direction:column;height:auto}
.logHeader{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
.log{flex:1 1 auto;min-height:0;overflow:auto;background:#0e1524;border:1px solid #25314a;border-radius:10px;padding:10px;color:#c6d0ec;font-size:13px;line-height:1.35}
.logPanel.collapsed{height:42px}
.logPanel.collapsed .log{display:none}

/* Menu, modals, dice */
.menu{position:fixed;inset:0;z-index:280;display:flex;align-items:center;justify-content:center;padding:16px;background:radial-gradient(1200px 600px at 50% 10%, #1a2440cc, transparent), linear-gradient(180deg,#0e1422f2,#0a0f18f2)}
.menu .cardmenu{background:linear-gradient(180deg,#0f1728,#0b1220);border:1px solid #2d3754;border-radius:20px;padding:22px;width:min(520px,92vw);box-shadow:0 28px 56px rgba(0,0,0,.55);display:flex;flex-direction:column;align-items:center}
.menu .muted{color:#acb6cf;font-size:13px;margin-bottom:12px}
.menu .items{display:flex;flex-direction:column;align-items:center;gap:12px;width:100%}
.menu .btn.big{font-size:16px;font-weight:800;padding:14px 18px;width:80%;max-width:360px}

.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;z-index:260;backdrop-filter:blur(2px)}
.modal .box{background:#10182a;border:1px solid #2a3450;border-radius:14px;max-width:720px;width:100%;box-shadow:0 10px 24px rgba(0,0,0,.5)}
.modal .head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #253254}
.modal .body{padding:12px;text-align:center}
.choices{display:flex;gap:8px;flex-wrap:wrap}
.choice{padding:8px 12px;border:1px solid #2a3142;border-radius:10px;background:#161b28;color:#dbe5ff;cursor:pointer}
.choice:hover{outline:2px solid var(--outline)}
.diceOverlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:240;background:rgba(5,8,12,.6)}
.diceArea{display:flex;gap:40px;align-items:center}
.die{width:72px;height:72px;position:relative;transform-style:preserve-3d;transform:rotateX(0) rotateY(0)}
.face{position:absolute;width:100%;height:100%;background:#e8eefc;border-radius:10px;box-shadow:inset 0 0 0 2px #b5c3ea;display:flex;align-items:center;justify-content:center;font-weight:900;color:#1b2b5a;font-size:28px}
.face:nth-child(1){transform:translateZ(36px)}
.face:nth-child(2){transform:rotateY(90deg) translateZ(36px)}
.face:nth-child(3){transform:rotateY(180deg) translateZ(36px)}
.face:nth-child(4){transform:rotateY(-90deg) translateZ(36px)}
.face:nth-child(5){transform:rotateX(90deg) translateZ(36px)}
.face:nth-child(6){transform:rotateX(-90deg) translateZ(36px)}
.diceTxt{color:#dbe5ff;font-weight:800;text-shadow:0 1px 0 #000}

.handRow::-webkit-scrollbar{display:none}
::-webkit-scrollbar{height:8px;width:8px}
::-webkit-scrollbar-track{background:#0b1019}
::-webkit-scrollbar-thumb{background:#22334a;border-radius:8px}

/* ===== Mobile-first ===== */
@media (max-width: 900px){
  :root{ --zone-k: 1.00; --zone-c: 14px; }
  :root{ --zone-k: 0.78; --zone-c: 20px; --card-w: clamp(34px, 8.8vw, 62px); --gap:8px; --page-max: 980px; }
  h1{font-size:15px}
  .pill{padding:4px 6px;font-size:11px}
  .title{font-size:12px}
  .L{font-size:clamp(16px, 4.9vw, 26px)}
  .boardGrid{inset:10px 0 0 0; gap:8px;}
  .boardFlat{height: calc(var(--card-w))} /* mobile fit */
  .zone{inset:8px}
  .logPanel{height:auto}
  .controls .btn{display:none}
  #hamburger{display:block}
}
@media (max-width: 600px){
  :root{ --zone-k: 1.04; --zone-c: 12px; }
  :root{ --zone-k: 0.78; --zone-c: 20px; --card-w: clamp(30px, 8.2vw, 56px); --gap:6px; }
  h1{font-size:13px}
  .pill{padding:3px 5px;font-size:10px}
  .title{font-size:12px}
  .L{font-size:clamp(15px, 4.4vw, 22px)}
  .boardGrid{inset:8px 0 0 0; gap:6px;}
  .boardFlat{height: calc(var(--card-w))}
  .zone{inset:7px}
  .logPanel{height:auto}
}

@media (min-width: 700px) and (max-width: 1180px){
  :root{ --zone-k: 0.86; --zone-c: 18px; }
  :root{ --zone-k: 0.78; --zone-c: 20px; --card-w: clamp(88px, 8.6vw, 140px); }
  .L{ font-size: clamp(30px, 5.4vw, 58px); }
  .boardFlat{ height: calc(var(--card-w)); }
  .handRow{ gap: 10px; }
}

</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="center">
      <div class="titlebar">
        <h1 id="titleTxt">F!RST</h1>
        <span class="pill"><span id="turnKey">Turn</span>: <b id="turnLbl">‚Äî</b></span>
        <span class="pill"><span id="yourHandKey">Your hand</span>: <b id="youHandCount">0</b>/7</span>
        <span class="pill"><span id="aiHandKey">AI hand</span>: <b id="aiHandCount">0</b> (<span id="hiddenKey">hidden</span>)</span>
        <span class="pill" id="timerPill">00:00</span>
      </div>
      <div class="controls">
        <button class="btn" id="langBtn" title="Language">üá¨üáß EN</button>
        <button class="btn" id="toMenuBtn">Menu</button>
        <button class="btn icon-btn" id="helpBtn">?</button>
        <button class="btn" id="restartBtn">New Game</button>
        <button class="btn" id="hamburger">‚ò∞</button>
      </div>
    </div>
    <div class="quickMenu" id="quickMenu">
      <button class="btn" id="qmLang">üá¨üáß EN</button>
      <button class="btn" id="qmMenu">Menu</button>
      <button class="btn" id="qmHelp">?</button>
      <button class="btn" id="qmNew">New Game</button>
    </div>
  </header>

  <div class="boardShell">
    <div class="center" style="height:100%">
      <div id="boardGrid" class="boardGrid">
        <div class="leftCol">
          <div id="panelAiSpace" class="panel">
            <div class="title"><span id="aiSpaceTitle">SPACE ‚Äî AI</span></div>
            <div class="boardFlat"><div id="aiSpace" class="zone"></div></div>
          </div>
          <div id="panelYouSpace" class="panel">
            <div class="title"><span id="youSpaceTitle">SPACE ‚Äî You</span></div>
            <div class="boardFlat"><div id="youSpace" class="zone"></div></div>
          </div>
          <div class="panel handPanel">
            <div class="title" id="yourHandTitle">Your hand <span class="note" id="handNote" style="display:none">(tap a card to play; turn ends automatically)</span></div>
            <div id="youHand" class="handRow"></div>
          </div>
        </div>
        <div class="rightCol">
          <div class="panel" id="panelAiDiscard">
            <div class="title" id="aiDiscardTitle">DISCARD ‚Äî AI</div>
            <div id="aiDiscard" class="stackPiles" style="flex:1 1 auto"></div>
          </div>
          <div class="panel" id="panelYouDiscard">
            <div class="title" id="youDiscardTitle">DISCARD ‚Äî You</div>
            <div id="youDiscard" class="stackPiles" style="flex:1 1 auto"></div>
          </div>
          <div class="panel logPanel" id="logPanel" style="flex:1 1 auto">
            <div class="logHeader">
              <div class="title" id="logTitle" style="margin:0">Game log</div>
              <button id="toggleLog" class="btn" style="padding:4px 10px">Hide</button>
            </div>
            <div id="log" class="log" style="flex:1 1 auto"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Menus and modals -->
<div id="menu" class="menu" style="display:flex">
  <div class="cardmenu">
    <div class="muted" id="welcomeTxt">Welcome to F!RST</div>
    <div class="items">
      <button class="btn big" id="menuNewGame">New Game</button>
      <button class="btn big" id="menuRules">Rules</button>
    </div>
  </div>
</div>

<div id="diceOverlay" class="diceOverlay">
  <div class="diceArea">
    <div>
      <div class="diceTxt" style="margin-bottom:6px;text-align:center" id="youTxt">You</div>
      <div id="dieYou" class="die">
        <div class="face">1</div><div class="face">2</div><div class="face">3</div>
        <div class="face">4</div><div class="face">5</div><div class="face">6</div>
      </div>
    </div>
    <div>
      <div class="diceTxt" style="margin-bottom:6px;text-align:center" id="aiTxt">AI</div>
      <div id="dieAI" class="die">
        <div class="face">1</div><div class="face">2</div><div class="face">3</div>
        <div class="face">4</div><div class="face">5</div><div class="face">6</div>
      </div>
    </div>
  </div>
</div>

<div class="modal" id="choiceModal">
  <div class="box">
    <div class="head"><div id="choiceTitle">Choose</div><div></div></div>
    <div class="body"><div id="choiceArea" class="choices"></div></div>
  </div>
</div>

<div class="modal" id="helpModal">
  <div class="box">
    <div class="head"><div style="font-weight:800" id="rulesTitle">F!RST ‚Äî rules & cards</div><button class="btn" id="closeHelp">Close</button></div>
    <div class="body"><div class="note" style="font-size:13px;color:#dfe7ff" id="rulesBody"></div></div>
  </div>
</div>

<div class="modal" id="winModal">
  <div class="box">
    <div class="head" style="justify-content:center;gap:10px"><div style="font-weight:800" id="gameOverKey">Game Over</div></div>
    <div class="body">
      <h3 id="winTitle">Victory!</h3>
      <div id="winMsg" class="msg">You completed a combo.</div>
      <div class="okbar" style="display:flex;justify-content:center;gap:8px;margin-top:8px">
        <button class="btn" id="winNew">New Game</button>
        <button class="btn" id="winMenu">Menu</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ===== i18n ===== */
const I18N={
  en:{title:"F!RST",turnKey:"Turn",yourHandKey:"Your hand",aiHandKey:"AI hand",hidden:"hidden",
      btnMenu:"Menu",btnNew:"New Game",welcome:"Welcome to F!RST",menuNew:"New Game",menuRules:"Rules",
      you:"You",ai:"AI",spaceAI:"SPACE ‚Äî AI",spaceYou:"SPACE ‚Äî You",discardAI:"DISCARD ‚Äî AI",discardYou:"DISCARD ‚Äî You",
      logTitle:"Game log",handTitle:"Your hand",handNote:"(tap a card to play; turn ends automatically)",
      rulesTitle:"F!RST ‚Äî rules & cards",gameOver:"Game Over",
      rulesBody:`Objective: assemble F I R S T or 5 of a kind. Cards: F=Forbid, I=Increase (draw 1), R=Recover (from DISCARD), S=Steal (from SPACE to DISCARD), T=Trap (opponent discards next turn).`,
      choose:"Choose",pickForbid:"Choose a letter to forbid",pickRecover:"Recover: choose a letter from your DISCARD",
      pickSteal:"Steal: choose a card from opponent SPACE",pickTrapDiscard:"Trap (T): choose a card to discard",
      drewYou:"You drew a card.",drewAI:"AI drew a card.",
      overflowYou:(c)=>`Your hand overflow: ${c} ‚Üí DISCARD.`,overflowAI:(c)=>`AI's hand overflow: ${c} ‚Üí DISCARD.`,
      playedYou:(c)=>`You played ${c}.`,playedAI:(c)=>`AI played ${c}.`,
      recoverYou:(c)=>`You recovered ${c} to hand.`,recoverAI:"AI recovered a card to hand.",
      stealYou:(c)=>`You moved opponent ${c} to DISCARD.`,stealAI:(c)=>`AI stole your ${c} to your DISCARD.`,
      tYou:"You set a Trap (T): AI will discard 1 next turn.",tAI:"AI set a Trap (T): you will discard 1 next turn.",
      winVictory:"Victory!",winDefeat:"Defeat",winDraw:"Draw",
      showLog:"Show",hideLog:"Hide"
  },
  ru:{title:"F!RST",turnKey:"–•–æ–¥",yourHandKey:"–¢–≤–æ—è —Ä—É–∫–∞",aiHandKey:"–†—É–∫–∞ –ò–ò",hidden:"—Å–∫—Ä—ã—Ç–∞",
      btnMenu:"–ú–µ–Ω—é",btnNew:"–ù–æ–≤–∞—è –∏–≥—Ä–∞",welcome:"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ F!RST",menuNew:"–ù–æ–≤–∞—è –∏–≥—Ä–∞",menuRules:"–ü—Ä–∞–≤–∏–ª–∞",
      you:"–¢—ã",ai:"–ò–ò",spaceAI:"SPACE ‚Äî –ò–ò",spaceYou:"SPACE ‚Äî –¢—ã",discardAI:"DISCARD ‚Äî –ò–ò",discardYou:"DISCARD ‚Äî –¢—ã",
      logTitle:"–ñ—É—Ä–Ω–∞–ª –±–æ—è",handTitle:"–¢–≤–æ—è —Ä—É–∫–∞",handNote:"(–Ω–∞–∂–º–∏ –Ω–∞ –∫–∞—Ä—Ç—É, —á—Ç–æ–±—ã —Å—ã–≥—Ä–∞—Ç—å; —Ö–æ–¥ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è —Å–∞–º)",
      rulesTitle:"F!RST ‚Äî –ø—Ä–∞–≤–∏–ª–∞ –∏ –∫–∞—Ä—Ç—ã",gameOver:"–ö–æ–Ω–µ—Ü –∏–≥—Ä—ã",
      rulesBody:`–¶–µ–ª—å: —Å–æ–±—Ä–∞—Ç—å F I R S T –∏–ª–∏ 5 –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö. F=Forbid, I=Increase (+1 –∫–∞—Ä—Ç–∞), R=Recover (–∏–∑ DISCARD), S=Steal (—Å–æ SPACE –≤ DISCARD), T=Trap (–ø—Ä–æ—Ç–∏–≤–Ω–∏–∫ —Å–±—Ä–æ—Å–∏—Ç –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥).`,
      choose:"–í—ã–±–æ—Ä",pickForbid:"–í—ã–±–µ—Ä–∏ –±—É–∫–≤—É –¥–ª—è –±–ª–æ–∫–∞",pickRecover:"Recover: –≤—ã–±–µ—Ä–∏ –±—É–∫–≤—É –∏–∑ DISCARD",
      pickSteal:"–£–∫–∞–∂–∏ –∫–∞—Ä—Ç—É –Ω–∞ —Å—Ç–æ–ª–µ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞",pickTrapDiscard:"–õ–æ–≤—É—à–∫–∞ (T): –≤—ã–±–µ—Ä–∏ –∫–∞—Ä—Ç—É –¥–ª—è —Å–±—Ä–æ—Å–∞",
      drewYou:"–¢—ã –≤–∑—è–ª –∫–∞—Ä—Ç—É.",drewAI:"–ò–ò –≤–∑—è–ª –∫–∞—Ä—Ç—É.",
      overflowYou:(c)=>`–ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä—É–∫–∏: ${c} ‚Üí DISCARD.`,overflowAI:(c)=>`–ü–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä—É–∫–∏ –ò–ò: ${c} ‚Üí DISCARD.`,
      playedYou:(c)=>`–¢—ã —Å—ã–≥—Ä–∞–ª ${c}.`,playedAI:(c)=>`–ò–ò —Å—ã–≥—Ä–∞–ª ${c}.`,
      recoverYou:(c)=>`–¢—ã –≤–µ—Ä–Ω—É–ª ${c} –≤ —Ä—É–∫—É.`,recoverAI:"–ò–ò –≤–µ—Ä–Ω—É–ª –∫–∞—Ä—Ç—É –≤ —Ä—É–∫—É.",
      stealYou:(c)=>`–¢—ã –æ—Ç–ø—Ä–∞–≤–∏–ª –∫–∞—Ä—Ç—É –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ ${c} –≤ DISCARD.`,stealAI:(c)=>`–ò–ò –æ—Ç–ø—Ä–∞–≤–∏–ª —Ç–≤–æ—é ${c} –≤ DISCARD.`,
      tYou:"–¢—ã –ø–æ—Å—Ç–∞–≤–∏–ª –õ–æ–≤—É—à–∫—É (T): –ò–ò —Å–±—Ä–æ—Å–∏—Ç 1 –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥.",tAI:"–ò–ò –ø–æ—Å—Ç–∞–≤–∏–ª –õ–æ–≤—É—à–∫—É (T): —Ç—ã —Å–±—Ä–æ—Å–∏—à—å 1 –≤ —Å–ª–µ–¥—É—é—â–∏–π —Ö–æ–¥.",
      winVictory:"–ü–æ–±–µ–¥–∞!",winDefeat:"–ü–æ—Ä–∞–∂–µ–Ω–∏–µ",winDraw:"–ù–∏—á—å—è",
      showLog:"–ü–æ–∫–∞–∑–∞—Ç—å",hideLog:"–°–∫—Ä—ã—Ç—å"
  }
};
let LANG='en';
function tt(key,...args){const v=I18N[LANG][key];return (typeof v==='function')?v(...args):v;}
function applyTexts(){
  document.getElementById('titleTxt').textContent=tt('title');
  document.getElementById('turnKey').textContent=tt('turnKey');
  document.getElementById('yourHandKey').textContent=tt('yourHandKey');
  document.getElementById('aiHandKey').textContent=tt('aiHandKey');
  document.getElementById('hiddenKey').textContent=tt('hidden');
  document.getElementById('toMenuBtn').textContent=tt('btnMenu');
  document.getElementById('restartBtn').textContent=tt('btnNew');
  document.getElementById('aiSpaceTitle').textContent=tt('spaceAI');
  document.getElementById('youSpaceTitle').textContent=tt('spaceYou');
  document.getElementById('aiDiscardTitle').textContent=tt('discardAI');
  document.getElementById('youDiscardTitle').textContent=tt('discardYou');
  document.getElementById('logTitle').textContent=tt('logTitle');
  document.getElementById('yourHandTitle').firstChild.textContent=tt('handTitle')+' ';
  document.getElementById('handNote').textContent=tt('handNote');
  document.getElementById('welcomeTxt').textContent=tt('welcome');
  document.getElementById('menuNewGame').textContent=tt('menuNew');
  document.getElementById('menuRules').textContent=tt('menuRules');
  document.getElementById('youTxt').textContent=tt('you');
  document.getElementById('aiTxt').textContent=tt('ai');
  document.getElementById('rulesTitle').textContent=tt('rulesTitle');
  document.getElementById('rulesBody').innerHTML=tt('rulesBody');
  document.getElementById('gameOverKey').textContent=tt('gameOver');
  document.getElementById('toggleLog').textContent = document.getElementById('logPanel').classList.contains('collapsed')?tt('showLog'):tt('hideLog');
  const langTxt = LANG==='en'?'üá¨üáß EN':'üá∑üá∫ RU';
  document.getElementById('langBtn').textContent= langTxt;
  document.getElementById('qmLang').textContent= langTxt;
  document.getElementById('qmMenu').textContent= tt('btnMenu');
  document.getElementById('qmHelp').textContent= '?';
  document.getElementById('qmNew').textContent= tt('btnNew');
}

/* Card helper */
function cardEl(letter, opts={}){
  const d=document.createElement('div');
  d.className='card'+(opts.hand?' hand':'')+(opts.clickable?' clickable':'');
  const span=document.createElement('div'); span.className='L '+letter; span.textContent=letter; d.appendChild(span);
  if(opts.clickable && opts.onClick) d.addEventListener('click', opts.onClick);
  return d;
}

/* ===== Game state and logic ===== */
const TYPES=['F','I','R','S','T'];
let G=null, timerId=null, elapsed=0;
function sideState(){ return { deck: buildDeck(), hand: [], space: [], discard: [] }; }
function buildDeck(){ const d=[]; for(let i=0;i<10;i++) for(const t of TYPES) d.push(t); return d; }
function shuffle(a){ for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }

function newGame(){
  document.getElementById('log').innerHTML='';
  G={ turn:null, firstPlayer:null, firstTurnDone:false,
      you:sideState(), ai:sideState(),
      traps:{ forbidYou:null, forbidAI:null, tNextYou:0, tNextAI:0 },
      over:false };
  shuffle(G.you.deck); shuffle(G.ai.deck);
  draw('you',5); draw('ai',5);
  startTimer(true);
  openDiceAndDecideFirstPlayer();
  render();
}

function setHUD(){
  document.getElementById('youHandCount').textContent=G.you.hand.length;
  document.getElementById('aiHandCount').textContent=G.ai.hand.length;
  document.getElementById('turnLbl').textContent= G.over? tt('gameOver') : (G.turn==='you'? tt('you') : tt('ai'));
  document.getElementById('timerPill').textContent = formatElapsed(elapsed);
}

function render(){
  setHUD();
  updateTurnHighlight();
  computeAdaptiveCardWidth();


  const aiS=document.getElementById('aiSpace'); aiS.innerHTML='';
  G.ai.space.forEach(c=> aiS.appendChild(cardEl(c)));
  const youS=document.getElementById('youSpace'); youS.innerHTML='';
  G.you.space.forEach(c=> youS.appendChild(cardEl(c)));
  const hand=document.getElementById('youHand'); hand.innerHTML='';
  G.you.hand.forEach((c,i)=> hand.appendChild(cardEl(c,{hand:true, clickable:G.turn==='you' && !G.over, onClick:()=>playFromHand(i)})));
  renderDiscard('aiDiscard', G.ai.discard);
  renderDiscard('youDiscard', G.you.discard);
  updateForbidFX();
  fitHandToSeven();
  fitMobileScale();
}

function updateForbidFX(){
  document.querySelectorAll('.forbidFx').forEach(el=> el.classList.remove('forbidFx'));
  document.querySelectorAll('.badge').forEach(el=> el.remove());
  if(G.traps.forbidAI){
    const idx = lastIndexOf(G.you.space,'F');
    const zone=document.getElementById('youSpace');
    if(idx>=0 && zone.children[idx]){
      const el=zone.children[idx]; el.classList.add('forbidFx');
      const b=document.createElement('div'); b.className='badge'; b.textContent=G.traps.forbidAI; el.appendChild(b);
    }
  }
  if(G.traps.forbidYou){
    const idx = lastIndexOf(G.ai.space,'F');
    const zone=document.getElementById('aiSpace');
    if(idx>=0 && zone.children[idx]) zone.children[idx].classList.add('forbidFx');
  }
}
function lastIndexOf(arr,val){ for(let i=arr.length-1;i>=0;i--){ if(arr[i]===val) return i; } return -1; }

function renderDiscard(containerId, discardArr){
  const box=document.getElementById(containerId); box.innerHTML='';
  const counts={F:0,I:0,R:0,S:0,T:0}; discardArr.forEach(x=>counts[x]++);
  const pile=document.createElement('div'); pile.className='pile';
  TYPES.forEach(t=>{ if(counts[t]===0) return; const m=document.createElement('div'); m.className='mini'; const b=document.createElement('b'); b.textContent=t; b.style.color=letterColor(t); m.appendChild(b); pile.appendChild(m); });
  const cnt=document.createElement('div'); cnt.className='count'; cnt.textContent=discardArr.length;
  pile.appendChild(cnt); box.appendChild(pile);
}
function letterColor(l){ return l==='F'?'#9cc8ff':l==='I'?'#a9ffcf':l==='R'?'#ffd195':l==='S'?'#ff9aa4':'#c6b3ff'; }

function logAdd(s){ const el=document.getElementById('log'); const div=document.createElement('div'); div.textContent=s; el.appendChild(div); el.scrollTop=el.scrollHeight; }

/* ====== Timer ====== */
function startTimer(reset){
  if(reset){ elapsed=0; }
  if(timerId) clearInterval(timerId);
  timerId=setInterval(()=>{ elapsed++; const p=document.getElementById('timerPill'); if(p) p.textContent=formatElapsed(elapsed); },1000);
}
function formatElapsed(sec){ const m = Math.floor(sec/60).toString().padStart(2,'0'); const s=(sec%60).toString().padStart(2,'0'); return `${m}:${s}`; }

/* ===== Flow ===== */
function draw(side,n){
  const S=(side==='you')?G.you:G.ai;
  for(let i=0;i<n;i++){
    if(S.deck.length===0){ defeat(side); return; }
    const c=S.deck.pop(); S.hand.push(c);
    logAdd(side==='you'?tt('drewYou'):tt('drewAI'));
    enforceHandLimit(side); if(G.over) return;
  }
}
function enforceHandLimit(side){
  const S=side==='you'?G.you:G.ai;
  while(S.hand.length>7){
    const overflow=S.hand.pop(); S.discard.push(overflow);
    logAdd(side==='you'?tt('overflowYou', overflow):tt('overflowAI', overflow));
  }
  render();
}

function updateTurnHighlight(){
  const youP=document.getElementById('panelYouSpace');
  const aiP =document.getElementById('panelAiSpace');
  youP.classList.toggle('activeTurn', G.turn==='you' && !G.over);
  aiP.classList.toggle('activeTurn',  G.turn==='ai'  && !G.over);
}

function startTurn(){
  if(G.over) return;
  const side=G.turn;
  const skip=(!G.firstTurnDone && G.turn===G.firstPlayer);
  if(!skip){ draw(side,1); if(G.over) return; }
  if(!G.firstTurnDone) G.firstTurnDone=true;

  if(side==='you' && G.traps.tNextYou>0){
    if(G.you.hand.length>0){
      chooseIndex(tt('pickTrapDiscard'), G.you.hand, (idx)=>{
        const dumped=G.you.hand.splice(idx,1)[0];
        G.you.discard.push(dumped);
        animateFromSpaceOrHand('you','hand',idx, document.getElementById('youDiscard'));
        logAdd("Trap: you discarded a card."); render(); G.traps.tNextYou=0;
        setTimeout(()=>{ if(!checkWin()) endTurn(); }, 300);
      });
      return;
    }else G.traps.tNextYou=0;
  }
  if(side==='ai' && G.traps.tNextAI>0){
    if(G.ai.hand.length>0){
      const dumpedIdx=Math.floor(Math.random()*G.ai.hand.length);
      const dumped=G.ai.hand.splice(dumpedIdx,1)[0];
      G.ai.discard.push(dumped);
      animateFromSpaceOrHand('ai','hand',dumpedIdx, document.getElementById('aiDiscard'));
      logAdd("Trap: AI discarded a card."); render();
    }
    G.traps.tNextAI=0;
  }

  render();
  if(side==='ai'){ setTimeout(aiPlay, 800+Math.random()*600); }
}

function endTurn(){ if(G.over) return; G.turn=(G.turn==='you')?'ai':'you'; render(); setTimeout(startTurn,380); }

function defeat(side){
  if(G.over) return; G.over=true;
  document.getElementById('winTitle').textContent = side==='you'? "üòû Defeat" : "üéâ Victory!";
  document.getElementById('winMsg').textContent = side==='you'? 'Your deck was empty on a required draw.' : 'AI had no cards to draw.';
  document.getElementById('winModal').style.display='flex';
}

function checkWin(){
  // Check win conditions for both sides
  const hasAll = (arr)=> TYPES.every(t=> arr.includes(t));
  const fiveOfOne = (arr)=> TYPES.some(t=> arr.filter(x=>x===t).length>=5);
  if(hasAll(G.you.space) || fiveOfOne(G.you.space)){ defeat('ai'); return true; }
  if(hasAll(G.ai.space)  || fiveOfOne(G.ai.space)){ defeat('you'); return true; }
  return false;
}

function playFromHand(index){
  if(G.over || G.turn!=='you') return;
  const letter=G.you.hand[index]; if(!letter) return;
  if(G.traps.forbidYou===letter){
    G.traps.forbidYou=null;
    const handEl=pickHandCardEl(index);
    G.you.hand.splice(index,1);
    animateForbidden(handEl, document.getElementById('youSpace'), document.getElementById('youDiscard'), letter);
    logAdd(`Forbid triggered: your ${letter} went to DISCARD.`);
    render(); if(!checkWin()) setTimeout(endTurn, 650); return;
  }
  const src=pickHandCardEl(index);
  G.you.hand.splice(index,1); G.you.space.push(letter);
  animateFly(src, document.getElementById('youSpace'));
  logAdd(`You played ${letter}.`); render();
  resolveEffect('you', letter, ()=>{ if(!checkWin()) endTurn(); });
}

function resolveEffect(side, letter, done){
  if(letter==='F'){
    chooseType(tt('pickForbid'), TYPES, (tChosen)=>{
      if(side==='you'){ G.traps.forbidAI=tChosen; logAdd("You forbade a letter for AI."); }
      else { G.traps.forbidYou=tChosen; logAdd("AI forbade a letter for you."); }
      render(); done();
    });
    return;
  }
  if(letter==='I'){ draw(side,1); done(); return; }
  if(letter==='R'){
    const S=side==='you'?G.you:G.ai;
    if(S.discard.length===0){ done(); return; }
    chooseType(tt('pickRecover'), uniqueLetters(S.discard), (pick)=>{
      const idx=S.discard.lastIndexOf(pick);
      if(idx>=0){
        const c=S.discard.splice(idx,1)[0];
        S.hand.push(c);
        animateFromDiscardTo(side, 'hand', c);
        logAdd(side==='you'?tt('recoverYou', c):tt('recoverAI')); enforceHandLimit(side);
      }
      render(); done();
    });
    return;
  }
  if(letter==='S'){
    const O=side==='you'?G.ai:G.you;
    if(O.space.length===0){ done(); return; }
    chooseIndex(tt('pickSteal'), O.space, (i)=>{
      animateFromSpaceOrHand(side==='you'?'ai':'you','space',i, side==='you'?document.getElementById('aiDiscard'):document.getElementById('youDiscard'));
      const removed=O.space.splice(i,1)[0]; O.discard.push(removed);
      logAdd(side==='you'?`You moved opponent ${removed} to DISCARD.`:`AI stole your ${removed} to your DISCARD.`);
      render(); done();
    });
    return;
  }
  if(letter==='T'){
    if(side==='you'){ G.traps.tNextAI++; logAdd(tt('tYou')); }
    else { G.traps.tNextYou++; logAdd(tt('tAI')); }
    done(); return;
  }
  done();
}

function uniqueLetters(arr){ return Array.from(new Set(arr)); }

function aiPlay(){
  if(G.over || G.turn!=='ai') return;
  const hand=G.ai.hand.slice(); if(hand.length===0){ endTurn(); return; }
  let idx=-1;
  if(G.you.space.length>0 && hand.includes('S')) idx=hand.indexOf('S');
  if(idx<0 && G.ai.discard.length>0 && hand.includes('R')) idx=hand.indexOf('R');
  if(idx<0 && hand.includes('F')) idx=hand.indexOf('F');
  if(idx<0 && hand.includes('T')) idx=hand.indexOf('T');
  if(idx<0 && hand.includes('I')) idx=hand.indexOf('I');
  if(idx<0) idx=0;
  const letter=hand[idx];
  if(G.traps.forbidAI===letter){
    G.traps.forbidAI=null;
    const fake=document.createElement('div'); fake.className='card'; fake.appendChild(Object.assign(document.createElement('div'),{className:'L '+letter,textContent:letter}));
    document.getElementById('aiSpace').appendChild(fake);
    setTimeout(()=>{
      animateFly(fake, document.getElementById('aiDiscard'));
      if(fake.parentNode) fake.parentNode.removeChild(fake);
    }, 50);
    G.ai.hand.splice(idx,1); G.ai.discard.push(letter);
    logAdd(`Forbid: AI's ${letter} went to DISCARD.`);
    render(); if(!checkWin()) setTimeout(endTurn, 650); return;
  }
  G.ai.hand.splice(idx,1); G.ai.space.push(letter);
  animateFly(null, document.getElementById('aiSpace'));
  logAdd(`AI played ${letter}.`); render();
  if(letter==='F'){
    const tChosen=pickMostType(G.you.space) || TYPES[Math.floor(Math.random()*5)];
    G.traps.forbidYou=tChosen; logAdd("AI forbade a letter for you."); render(); finalize(); return;
  }
  if(letter==='I'){ draw('ai',1); finalize(); return; }
  if(letter==='R'){
    if(G.ai.discard.length>0){
      const c=G.ai.discard.pop(); G.ai.hand.push(c);
      animateFromDiscardTo('ai','hand', c);
      logAdd(tt('recoverAI')); enforceHandLimit('ai');
    }
    finalize(); return;
  }
  if(letter==='S'){
    if(G.you.space.length>0){
      const i=G.you.space.length-1;
      animateFromSpaceOrHand('you','space',i, document.getElementById('youDiscard'));
      const removed=G.you.space.pop(); G.you.discard.push(removed);
      logAdd(`AI stole your ${removed} to your DISCARD.`); render();
    }
    finalize(); return;
  }
  if(letter==='T'){ G.traps.tNextYou++; logAdd(tt('tAI')); finalize(); return; }
  finalize();
  function finalize(){ if(!checkWin()) endTurn(); }
}

function pickMostType(arr){ const m={}; for(const x of arr){m[x]=(m[x]||0)+1;} let b=null,v=-1; for(const [k,c] of Object.entries(m)){ if(c>v){b=k; v=c;} } return b; }

/* Dice */
function openDiceAndDecideFirstPlayer(){
  const overlay=document.getElementById('diceOverlay'); overlay.style.display='flex';
  let you=rand1to6(), ai=rand1to6(); if(you===ai){ do{ you=rand1to6(); ai=rand1to6(); }while(you===ai); }
  animateDice('dieYou',you); animateDice('dieAI',ai);
  setTimeout(()=>{
    G.firstPlayer= you>ai?'you':'ai';
    overlay.style.display='none'; G.turn=G.firstPlayer; render(); startTurn();
  },1700);
}
function rand1to6(){ return 1+Math.floor(Math.random()*6); }
function animateDice(id,val){
  const die=document.getElementById(id); const target=faceRotation(val);
  if(window.gsap && gsap.to){ const tl=gsap.timeline(); tl.to(die,{duration:0.6,rotateX:360,rotateY:360,ease:"power2.out"}).to(die,{duration:0.7,rotateX:target.x,rotateY:target.y,ease:"power3.out"}); }
  else { const t0=performance.now(),dur=700; function step(now){ const p=Math.min(1,(now-t0)/dur); const ex=target.x*p, ey=target.y*p; die.style.transform=`rotateX(${ex}deg) rotateY(${ey}deg)`; if(p<1) requestAnimationFrame(step); } requestAnimationFrame(step); }
}
function faceRotation(v){ switch(v){ case 1:return{x:0,y:0}; case 2:return{x:0,y:-90}; case 3:return{x:0,y:180}; case 4:return{x:0,y:90}; case 5:return{x:-90,y:0}; case 6:return{x:90,y:0}; } return{x:0,y:0}; }

/* ===== Anim & helpers ===== */
function pickHandCardEl(index){ const hand=document.getElementById('youHand'); return hand.children[index]; }
function animateFly(fromEl,toContainer){
  const rectTo=toContainer.getBoundingClientRect();
  let rectFrom;
  let ghost;
  if(fromEl){
    rectFrom=fromEl.getBoundingClientRect();
    ghost=fromEl.cloneNode(true);
  }else{
    rectFrom={left:rectTo.left,top:rectTo.top,width:20,height:20};
    ghost=document.createElement('div'); ghost.className='card'; const s=document.createElement('div'); s.className='L'; s.textContent=''; ghost.appendChild(s);
  }
  const targetX=rectTo.left+rectTo.width/2-(rectFrom.left+rectFrom.width/2);
  const targetY=rectTo.top+rectTo.height/2-(rectFrom.top+rectFrom.height/2);
  ghost.style.position='fixed'; ghost.style.left=(rectFrom.left)+'px'; ghost.style.top=(rectFrom.top)+'px'; ghost.style.margin='0'; ghost.style.zIndex='250'; ghost.style.pointerEvents='none';
  document.body.appendChild(ghost);
  const t0=performance.now(),dur=500; function step(now){ const p=Math.min(1,(now-t0)/dur); const x=targetX*p, y=targetY*p, s=1-0.12*p; ghost.style.transform=`translate(${x}px, ${y}px) scale(${s})`; if(p<1) requestAnimationFrame(step); else document.body.removeChild(ghost);} requestAnimationFrame(step);
}
function animateForbidden(fromEl,spaceContainer,discardContainer,letter){
  animateFly(fromEl, spaceContainer);
  setTimeout(()=>{
    const fake=document.createElement('div'); fake.className='card'; const L=document.createElement('div'); L.className='L '+letter; L.textContent=letter; fake.appendChild(L);
    const rectSpace=spaceContainer.getBoundingClientRect();
    fake.style.position='fixed'; fake.style.left=(rectSpace.left+24)+'px'; fake.style.top=(rectSpace.top+24)+'px'; fake.style.margin='0'; fake.style.zIndex='250'; fake.style.pointerEvents='none';
    document.body.appendChild(fake);
    animateFly(fake, discardContainer);
    setTimeout(()=>{ if(fake.parentNode) fake.parentNode.removeChild(fake); }, 520);
  }, 250);
}
function animateFromSpaceOrHand(side,area,index,targetContainer){
  const zoneId= side==='you' ? (area==='space'?'youSpace':'youHand') : (area==='space'?'aiSpace':'aiHandHidden');
  const zone=document.getElementById(zoneId);
  if(!zone||!zone.children||index<0||index>=zone.children.length){ return; }
  const fromEl=zone.children[index]; animateFly(fromEl, targetContainer);
}
function animateFromDiscardTo(side,dest,letter){
  const from=document.getElementById(side==='you'?'youDiscard':'aiDiscard');
  const to  =document.getElementById(side==='you'?'youHand':'aiSpace');
  if(!from||!to) return;
  const ghost=document.createElement('div'); ghost.className='card'; const L=document.createElement('div'); L.className='L '+letter; L.textContent=letter; ghost.appendChild(L);
  const rectFrom=from.getBoundingClientRect();
  ghost.style.position='fixed'; ghost.style.left=(rectFrom.left+rectFrom.width*0.3)+'px'; ghost.style.top=(rectFrom.top+rectFrom.height*0.3)+'px'; ghost.style.zIndex='250';
  document.body.appendChild(ghost);
  animateFly(ghost, to);
  setTimeout(()=>{ if(ghost.parentNode) ghost.parentNode.removeChild(ghost); }, 600);
}

/* ===== Layout helpers ===== */

function computeAdaptiveCardWidth(){
  const root = document.documentElement;
  const handRow = document.getElementById('youHand');
  const headerH = document.querySelector('header').getBoundingClientRect().height;
  const grid = document.getElementById('boardGrid');
  // Available height for left column panels
  const vh = window.innerHeight;
  const leftCol = document.querySelector('.leftCol');
  const gaps = parseFloat(getComputedStyle(leftCol).gap || 8) * 2; // approx
  const panels = 3;
  const availForPanels = Math.max(200, vh - headerH - 24);
  const perPanel = (availForPanels - gaps) / panels;

  // From height: boardFlat height = cardW * zoneK + zoneC + inner paddings (~22)
  const cs = getComputedStyle(root);
  const zoneK = parseFloat(cs.getPropertyValue('--zone-k')) || 1.0;
  const zoneCpx = parseFloat((cs.getPropertyValue('--zone-c')||'0').replace('px','')) || 16;
  const innerPad = 22; // title + insets approximation
  const maxFromHeight = Math.max(32, (perPanel - innerPad - zoneCpx) / Math.max(0.6, zoneK));

  // From width: hand should fit 7 cards without scroll
  // precise inner width = clientWidth - horizontal paddings
  const csRow = getComputedStyle(handRow);
  const padL = parseFloat(csRow.paddingLeft)||0;
  const padR = parseFloat(csRow.paddingRight)||0;
  const handW = (handRow.clientWidth - padL - padR) || (window.innerWidth * 0.9);
  const handGaps = 8 * 6; // 6 gaps by CSS
  const SAFETY = 6; // compensate borders/rounding to avoid overflow
  const fromHand = Math.max(26, Math.floor((handW - handGaps - SAFETY)/7));

  // Base card variable (desktop cap keeps aesthetic)
  const base = Math.min(fromHand, maxFromHeight, 160);
  root.style.setProperty('--card-w', Math.floor(base) + 'px');
  // Hand cards may be slightly larger to fill row
  root.style.setProperty('--card-w-hand', Math.floor(fromHand) + 'px');
}

function fitHandToSeven(){
  const row=document.getElementById('youHand');
  const csRow = getComputedStyle(row);
  const w=row.clientWidth - (parseFloat(csRow.paddingLeft)||0) - (parseFloat(csRow.paddingRight)||0);
  const gaps=8*6; let target=Math.floor((w-gaps-6)/7);
  if(window.innerWidth>=700 && window.innerWidth<=1180){ target = Math.floor(target*1.08); }
  const max=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--card-w').match(/\d+/));
  const cardW=Math.max(40, Math.min(target, Math.floor((max||120)*1.12)));
  document.documentElement.style.setProperty('--card-w-hand', cardW+'px');
}

let scaleApplied=1;




function fitMobileScale(){
  const grid=document.getElementById('boardGrid');
  if(window.innerWidth>=1000){ grid.style.transform='scale(1)'; scaleApplied=1; return; }
  const headerH=document.querySelector('header').getBoundingClientRect().height;
  const safe = (window.visualViewport && window.visualViewport.height? (window.innerHeight - window.visualViewport.height) : 0);
  const avail=window.innerHeight - headerH - 6 - safe; if(avail<=0) return;
  grid.style.transform='scale(1)';
  const natural=grid.getBoundingClientRect().height;
  let s=Math.min(1, avail / natural);
  s = Math.max(0.58, Math.min(1, s));
  s = Math.round(s*100)/100;
  grid.style.transform=`scale(${s})`;
  scaleApplied=s;
}

/* ===== Choices, win check, menu & help ===== */
function chooseType(title, options, cb){
  const modal = document.getElementById('choiceModal');
  const ttl   = document.getElementById('choiceTitle');
  const area  = document.getElementById('choiceArea');
  if(!modal||!ttl||!area) return;
  ttl.textContent = tt('choose') + ': ' + title;
  area.innerHTML='';
  options.forEach(o=>{
    const b=document.createElement('button');
    b.className='btn';
    b.textContent=o;
    b.addEventListener('click', ()=>{ modal.style.display='none'; cb(o); });
    area.appendChild(b);
  });
  modal.style.display='flex';
}
function chooseIndex(title, list, cb){
  const modal = document.getElementById('choiceModal');
  const ttl   = document.getElementById('choiceTitle');
  const area  = document.getElementById('choiceArea');
  if(!modal||!ttl||!area) return;
  ttl.textContent = tt('choose') + ': ' + title;
  area.innerHTML='';
  list.forEach((letter, idx)=>{
    const b=document.createElement('button');
    b.className='btn';
    b.textContent=letter;
    b.addEventListener('click', ()=>{ modal.style.display='none'; cb(idx); });
    area.appendChild(b);
  });
  modal.style.display='flex';
}

function on(id, ev, fn){ const el=document.getElementById(id); if(el) el.addEventListener(ev, fn); }
function setupEvents(){
  on('menuNewGame','click', ()=>{ const m=document.getElementById('menu'); if(m) m.style.display='none'; newGame(); });
  on('menuRules','click', ()=>{ const m=document.getElementById('menu'); if(m) m.style.display='none'; const h=document.getElementById('helpModal'); if(h) h.style.display='flex'; });
  on('toMenuBtn','click', ()=>{ const m=document.getElementById('menu'); if(m) m.style.display='flex'; });
  on('restartBtn','click', ()=>{ newGame(); });
  on('helpBtn','click', ()=>{ const h=document.getElementById('helpModal'); if(h) h.style.display='flex'; });
  on('closeHelp','click', ()=>{ const h=document.getElementById('helpModal'); if(h) h.style.display='none'; });
  on('winClose','click', ()=>{ const w=document.getElementById('winModal'); if(w) w.style.display='none'; });
  on('winMenu','click', ()=>{ const w=document.getElementById('winModal'); if(w) w.style.display='none'; const m=document.getElementById('menu'); if(m) m.style.display='flex'; });
  on('winNew','click', ()=>{ const w=document.getElementById('winModal'); if(w) w.style.display='none'; newGame(); });
  on('langBtn','click', ()=>{ LANG=(LANG==='en')?'ru':'en'; applyTexts(); render(); });
  on('toggleLog','click', ()=>{ const p=document.getElementById('logPanel'); if(p){ p.classList.toggle('collapsed'); applyTexts(); } });
  // Hamburger
  const burger=document.getElementById('hamburger');
  const qMenu=document.getElementById('quickMenu');
  if(burger && qMenu){
    burger.addEventListener('click', (e)=>{ e.stopPropagation(); qMenu.style.display=(qMenu.style.display==='flex')?'none':'flex'; });
    document.addEventListener('click', ()=>{ if(qMenu.style.display==='flex') qMenu.style.display='none'; });
  }
  on('qmLang','click',(e)=>{ e.stopPropagation(); LANG=(LANG==='en')?'ru':'en'; applyTexts(); render(); });
  on('qmRules','click',(e)=>{ e.stopPropagation(); const h=document.getElementById('helpModal'); if(h) h.style.display='flex'; });
  on('qmNew','click',(e)=>{ e.stopPropagation(); newGame(); });
  on('qmFull','click',(e)=>{ e.stopPropagation(); if(document.documentElement.requestFullscreen){ document.documentElement.requestFullscreen(); }});
}
// boot after DOM ready
(function(){
  const boot=()=>{ try{ computeAdaptiveCardWidth(); fitHandToSeven(); fitMobileScale(); setupEvents(); render(); }catch(e){ console.error(e);} };
  if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', boot, {once:true});
  else boot();
})();

</script>
</body>
</html>
